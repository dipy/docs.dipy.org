
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples_built/preprocessing/motion_correction.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_examples_built_preprocessing_motion_correction.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_built_preprocessing_motion_correction.py:


=================================================
Between-volumes Motion Correction on DWI datasets
=================================================

During a dMRI acquisition, the subject motion inevitable. This motion implies
a misalignment between N volumes on a dMRI dataset. A common way to solve this
issue is to perform a registration on each acquired volume to a
reference b = 0 :footcite:p:`Jenkinson2001`.

This preprocessing is a highly recommended step that should be executed before
any dMRI dataset analysis.


Let's import some essential functions.

.. GENERATED FROM PYTHON SOURCE LINES 18-25

.. code-block:: Python


    from dipy.align import motion_correction
    from dipy.core.gradients import gradient_table
    from dipy.data import get_fnames
    from dipy.io.gradients import read_bvals_bvecs
    from dipy.io.image import load_nifti, save_nifti








.. GENERATED FROM PYTHON SOURCE LINES 26-28

We choose one of the data from the datasets in dipy_. However, you can
replace the following line with the path of your image.

.. GENERATED FROM PYTHON SOURCE LINES 28-31

.. code-block:: Python


    dwi_fname, dwi_bval_fname, dwi_bvec_fname = get_fnames(name="sherbrooke_3shell")








.. GENERATED FROM PYTHON SOURCE LINES 32-35

We load the image and the affine of the image. The affine is the
transformation matrix which maps image coordinates to world (mm) coordinates.
We also load the b-values and b-vectors.

.. GENERATED FROM PYTHON SOURCE LINES 35-39

.. code-block:: Python


    data, affine = load_nifti(dwi_fname)
    bvals, bvecs = read_bvals_bvecs(dwi_bval_fname, dwi_bvec_fname)








.. GENERATED FROM PYTHON SOURCE LINES 40-43

This data has 193 volumes. For this demo purpose, we decide to reduce the
number of volumes to 3. However, we do not recommend to perform a motion
correction with less than 10 volumes.

.. GENERATED FROM PYTHON SOURCE LINES 43-49

.. code-block:: Python


    data_small = data[..., :3]
    bvals_small = bvals[:3]
    bvecs_small = bvecs[:3]
    gtab = gradient_table(bvals_small, bvecs=bvecs_small)








.. GENERATED FROM PYTHON SOURCE LINES 50-52

Start motion correction of our reduced DWI dataset(between-volumes motion
correction).

.. GENERATED FROM PYTHON SOURCE LINES 52-55

.. code-block:: Python


    data_corrected, reg_affines = motion_correction(data_small, gtab, affine=affine)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]
    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]
    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]
    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]
    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]
    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]




.. GENERATED FROM PYTHON SOURCE LINES 56-57

Save our DWI dataset corrected to a new Nifti file.

.. GENERATED FROM PYTHON SOURCE LINES 57-62

.. code-block:: Python


    save_nifti(
        "motion_correction.nii.gz", data_corrected.get_fdata(), data_corrected.affine
    )








.. GENERATED FROM PYTHON SOURCE LINES 63-68

References
----------

.. footbibliography::


.. GENERATED FROM PYTHON SOURCE LINES 70-72

.. include:: ../../links_names.inc



.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (1 minutes 14.876 seconds)


.. _sphx_glr_download_examples_built_preprocessing_motion_correction.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: motion_correction.ipynb <motion_correction.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: motion_correction.py <motion_correction.py>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
