
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples_built\reconstruction\reconst_qti.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_examples_built_reconstruction_reconst_qti.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_built_reconstruction_reconst_qti.py:


=================================================
Reconstruct with Q-space Trajectory Imaging (QTI)
=================================================

Q-space trajectory imaging (QTI) by Westin et al. [1]_ is a general framework
for analyzing diffusion-weighted MRI data acquired with tensor-valued diffusion
encoding. This tutorial briefly summarizes the theory and provides an example
of how to estimate the diffusion and covariance tensors using DIPY.

Theory
======

In QTI, the tissue microstructure is represented by a diffusion tensor
distribution (DTD). Here, DTD is denoted by $\mathbf{D}$ and the voxel-level
diffusion tensor from DTI by $\langle\mathbf{D}\rangle$, where
$\langle \ \rangle$ denotes averaging over the DTD. The covariance of
$\mathbf{D}$ is given by a fourth-order covariance tensor $\mathbb{C}$
defined as

.. math::

   \mathbb{C} = \langle \mathbf{D} \otimes \mathbf{D} \rangle - \langle
   \mathbf{D} \rangle \otimes \langle \mathbf{D} \rangle ,

where $\otimes$ denotes a tensor outer product. $\mathbb{C}$ has 21 unique
elements and enables the calculation of several microstructural parameters.

Using the cumulant expansion, the diffusion-weighted signal can be approximated
as

.. math::
   S \approx S_0 \exp \left(- \mathbf{b} : \langle \mathbf{D} \rangle +
   \frac{1}{2}(\mathbf{b} \otimes \mathbf{b}) : \mathbb{C} \right) ,

where $S_0$ is the signal without diffusion-weighting, $\mathbf{b}$ is the
b-tensor used in the acquisition, and $:$ denotes a tensor inner product.

The model parameters $S_0$, $\langle\mathbf{D}\rangle$, and $\mathbb{C}$
can be estimated by solving the following equation:

.. math::

   S = \beta X,

where

.. math::

   S = \begin{pmatrix} \ln S_1 \ \vdots \ \ln S_n \end{pmatrix} ,

.. math::

   \beta = \begin{pmatrix} \ln S_0 & \langle \mathbf{D}
   \rangle & \mathbb{C} \end{pmatrix}^\text{T} ,

.. math::

   X =
   \begin{pmatrix}
   1 & -\mathbf{b}_1^\text{T} & \frac{1}{2} (\mathbf{b}_1 \otimes
   \mathbf{b}_1) \text{T} \
   \vdots & \vdots & \vdots \
   1 & -\mathbf{b}_n^\text{T} & \frac{1}{2} (\mathbf{b}_n \otimes
   \mathbf{b}_n) ^\text{T}
   \end{pmatrix} ,

where $n$ is the number of acquisitions and $\langle\mathbf{D}\rangle$,
$\mathbb{C}$, $\mathbf{b}_i$, and $(\mathbf{b}_i \otimes \mathbf{b}_i)$
are represented by column vectors using Voigt notation. Estimation of the
model parameters requires that
$\text{rank}(\mathbf{X}^\text{T}\mathbf{X}) = 28$.
This can be achieved by combining acquisitions with b-tensors with different
shapes, sizes, and orientations.

For details, please see [1]_.

Usage example
=============

QTI can be fit to data using the module `dipy.reconst.qti`. Let's start by
importing the required modules and functions:

.. GENERATED FROM PYTHON SOURCE LINES 84-93

.. code-block:: Python


    from dipy.core.gradients import gradient_table
    from dipy.data import get_fnames
    from dipy.io.gradients import read_bvals_bvecs
    from dipy.io.image import load_nifti
    import matplotlib.pyplot as plt
    import numpy as np
    import dipy.reconst.qti as qti








.. GENERATED FROM PYTHON SOURCE LINES 94-96

As QTI requires data with tensor-valued encoding, let's load an example
dataset acquired with q-space trajectory encoding (QTE):

.. GENERATED FROM PYTHON SOURCE LINES 96-104

.. code-block:: Python


    fdata, fbvals, fbvecs, fmask = get_fnames('qte_lte_pte')
    data, affine = load_nifti(fdata)
    mask, _ = load_nifti(fmask)
    bvals, bvecs = read_bvals_bvecs(fbvals, fbvecs)
    btens = np.array(['LTE' for i in range(61)] + ['PTE' for i in range(61)])
    gtab = gradient_table(bvals, bvecs, btens=btens)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|                                                                                                                            | 0/2530 [00:00<?, ? MB/s]      0%|                                                                                                                    | 1/2530 [00:00<04:53,  8.60 MB/s]      0%|▏                                                                                                                   | 4/2530 [00:00<02:14, 18.81 MB/s]      0%|▎                                                                                                                   | 8/2530 [00:00<01:42, 24.67 MB/s]      1%|▊                                                                                                                  | 18/2530 [00:00<00:51, 48.94 MB/s]      1%|█▌                                                                                                                 | 33/2530 [00:00<00:31, 78.09 MB/s]      2%|██▏                                                                                                                | 49/2530 [00:00<00:24, 99.44 MB/s]      3%|██▉                                                                                                               | 66/2530 [00:00<00:21, 116.23 MB/s]      3%|███▋                                                                                                              | 83/2530 [00:00<00:19, 127.43 MB/s]      4%|████▌                                                                                                            | 102/2530 [00:01<00:17, 140.49 MB/s]      5%|█████▍                                                                                                           | 121/2530 [00:01<00:16, 149.34 MB/s]      6%|██████▎                                                                                                          | 141/2530 [00:01<00:15, 158.27 MB/s]      6%|███████▏                                                                                                         | 162/2530 [00:01<00:13, 171.51 MB/s]      7%|████████▎                                                                                                        | 185/2530 [00:01<00:13, 178.27 MB/s]      8%|█████████▎                                                                                                       | 208/2530 [00:01<00:12, 182.90 MB/s]      9%|██████████▍                                                                                                      | 233/2530 [00:01<00:11, 193.87 MB/s]     10%|███████████▌                                                                                                     | 259/2530 [00:01<00:11, 205.33 MB/s]     11%|████████████▊                                                                                                    | 286/2530 [00:01<00:10, 215.95 MB/s]     12%|██████████████                                                                                                   | 314/2530 [00:02<00:09, 226.39 MB/s]     14%|███████████████▎                                                                                                 | 343/2530 [00:02<00:09, 236.21 MB/s]     15%|████████████████▋                                                                                                | 374/2530 [00:02<00:08, 248.39 MB/s]     16%|██████████████████▏                                                                                              | 407/2530 [00:02<00:08, 255.63 MB/s]     17%|███████████████████▋                                                                                             | 442/2530 [00:02<00:07, 272.41 MB/s]     19%|█████████████████████▎                                                                                           | 478/2530 [00:02<00:07, 287.03 MB/s]     20%|███████████████████████                                                                                          | 516/2530 [00:02<00:06, 302.51 MB/s]     22%|████████████████████████▊                                                                                        | 556/2530 [00:02<00:06, 320.37 MB/s]     24%|██████████████████████████▊                                                                                      | 599/2530 [00:02<00:05, 337.79 MB/s]     25%|████████████████████████████▋                                                                                    | 643/2530 [00:03<00:05, 354.21 MB/s]     27%|██████████████████████████████▊                                                                                  | 689/2530 [00:03<00:05, 363.52 MB/s]     29%|████████████████████████████████▉                                                                                | 738/2530 [00:03<00:04, 385.39 MB/s]     31%|███████████████████████████████████▏                                                                             | 789/2530 [00:03<00:04, 404.55 MB/s]     33%|█████████████████████████████████████▌                                                                           | 841/2530 [00:03<00:03, 423.33 MB/s]     35%|████████████████████████████████████████                                                                         | 897/2530 [00:03<00:03, 446.04 MB/s]     38%|██████████████████████████████████████████▋                                                                      | 956/2530 [00:03<00:03, 469.88 MB/s]     40%|█████████████████████████████████████████████                                                                   | 1018/2530 [00:03<00:03, 495.08 MB/s]     43%|███████████████████████████████████████████████▉                                                                | 1083/2530 [00:03<00:02, 528.71 MB/s]     45%|██████████████████████████████████████████████████▉                                                             | 1151/2530 [00:04<00:02, 537.30 MB/s]     48%|██████████████████████████████████████████████████████▏                                                         | 1223/2530 [00:04<00:02, 586.66 MB/s]     51%|█████████████████████████████████████████████████████████▍                                                      | 1298/2530 [00:04<00:02, 588.58 MB/s]     54%|████████████████████████████████████████████████████████████▉                                                   | 1376/2530 [00:04<00:01, 632.06 MB/s]     58%|████████████████████████████████████████████████████████████████▌                                               | 1459/2530 [00:04<00:01, 650.07 MB/s]     61%|████████████████████████████████████████████████████████████████████▍                                           | 1547/2530 [00:04<00:01, 690.29 MB/s]     65%|████████████████████████████████████████████████████████████████████████▌                                       | 1638/2530 [00:04<00:01, 722.68 MB/s]     68%|████████████████████████████████████████████████████████████████████████████▋                                   | 1733/2530 [00:04<00:01, 759.60 MB/s]     72%|█████████████████████████████████████████████████████████████████████████████████▏                              | 1834/2530 [00:04<00:00, 801.76 MB/s]     77%|█████████████████████████████████████████████████████████████████████████████████████▊                          | 1938/2530 [00:05<00:00, 839.00 MB/s]     81%|██████████████████████████████████████████████████████████████████████████████████████████▋                     | 2049/2530 [00:05<00:00, 884.10 MB/s]     86%|███████████████████████████████████████████████████████████████████████████████████████████████▉                | 2166/2530 [00:05<00:00, 931.16 MB/s]     90%|█████████████████████████████████████████████████████████████████████████████████████████████████████▎          | 2288/2530 [00:05<00:00, 979.13 MB/s]     95%|█████████████████████████████████████████████████████████████████████████████████████████████████████████▉     | 2415/2530 [00:05<00:00, 1025.81 MB/s]    100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2530/2530 [00:05<00:00, 452.44 MB/s]
      0%|                                                                                                                               | 0/1 [00:00<?, ? MB/s]    100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00<00:00, 486.07 MB/s]
      0%|                                                                                                                               | 0/1 [00:00<?, ? MB/s]    100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00<?, ? MB/s]
      0%|                                                                                                                               | 0/1 [00:00<?, ? MB/s]    100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00<?, ? MB/s]




.. GENERATED FROM PYTHON SOURCE LINES 105-109

The dataset contains 122 volumes of which the first half were acquired with
linear tensor encoding (LTE) and the second half with planar tensor encoding
(PTE). We can confirm this by calculating the ranks of the b-tensors in the
gradient table.

.. GENERATED FROM PYTHON SOURCE LINES 109-114

.. code-block:: Python


    ranks = np.array([np.linalg.matrix_rank(b) for b in gtab.btens])
    for i, l in enumerate(['b = 0', 'LTE', 'PTE']):
        print('%s volumes with %s' % (np.sum(ranks == i), l))





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    2 volumes with b = 0
    60 volumes with LTE
    60 volumes with PTE




.. GENERATED FROM PYTHON SOURCE LINES 115-118

Now that we have data acquired with tensor-valued diffusion encoding and the
corresponding gradient table containing the b-tensors, we can fit QTI to the
data as follows:

.. GENERATED FROM PYTHON SOURCE LINES 118-122

.. code-block:: Python


    qtimodel = qti.QtiModel(gtab)
    qtifit = qtimodel.fit(data, mask)








.. GENERATED FROM PYTHON SOURCE LINES 123-126

QTI parameter maps can accessed as the attributes of `qtifit`. For instance,
fractional anisotropy (FA) and microscopic fractional anisotropy (μFA) maps
can be calculated as:

.. GENERATED FROM PYTHON SOURCE LINES 126-130

.. code-block:: Python


    fa = qtifit.fa
    ufa = qtifit.ufa





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    C:\Users\skoudoro\Devel\dipy\dipy\reconst\qti.py:954: RuntimeWarning: invalid value encountered in sqrt
      ufa = np.sqrt(self.c_mu)




.. GENERATED FROM PYTHON SOURCE LINES 131-133

Finally, let's reproduce Figure 9 from [1]_ to visualize more QTI parameter
maps:

.. GENERATED FROM PYTHON SOURCE LINES 133-180

.. code-block:: Python


    z = 36

    fig, ax = plt.subplots(3, 4, figsize=(12, 9))

    background = np.zeros(data.shape[0:2])  # Black background for figures
    for i in range(3):
        for j in range(4):
            ax[i, j].imshow(background, cmap='gray')
            ax[i, j].set_xticks([])
            ax[i, j].set_yticks([])

    ax[0, 0].imshow(np.rot90(qtifit.md[:, :, z]), cmap='gray', vmin=0, vmax=3e-3)
    ax[0, 0].set_title('MD')
    ax[0, 1].imshow(np.rot90(qtifit.v_md[:, :, z]),
                    cmap='gray', vmin=0, vmax=.5e-6)
    ax[0, 1].set_title('V$_{MD}$')
    ax[0, 2].imshow(np.rot90(qtifit.v_shear[:, :, z]), cmap='gray', vmin=0,
                    vmax=.5e-6)
    ax[0, 2].set_title('V$_{shear}$')
    ax[0, 3].imshow(np.rot90(qtifit.v_iso[:, :, z]),
                    cmap='gray', vmin=0, vmax=1e-6)
    ax[0, 3].set_title('V$_{iso}$')

    ax[1, 0].imshow(np.rot90(qtifit.c_md[:, :, z]), cmap='gray', vmin=0, vmax=.25)
    ax[1, 0].set_title('C$_{MD}$')
    ax[1, 1].imshow(np.rot90(qtifit.c_mu[:, :, z]), cmap='gray', vmin=0, vmax=1)
    ax[1, 1].set_title('C$_{μ}$ = μFA$^2$')
    ax[1, 2].imshow(np.rot90(qtifit.c_m[:, :, z]), cmap='gray', vmin=0, vmax=1)
    ax[1, 2].set_title('C$_{M}$ = FA$^2$')
    ax[1, 3].imshow(np.rot90(qtifit.c_c[:, :, z]), cmap='gray', vmin=0, vmax=1)
    ax[1, 3].set_title('C$_{c}$')

    ax[2, 0].imshow(np.rot90(qtifit.mk[:, :, z]), cmap='gray', vmin=0, vmax=1.5)
    ax[2, 0].set_title('MK')
    ax[2, 1].imshow(np.rot90(qtifit.k_bulk[:, :, z]),
                    cmap='gray', vmin=0, vmax=1.5)
    ax[2, 1].set_title('K$_{bulk}$')
    ax[2, 2].imshow(np.rot90(qtifit.k_shear[:, :, z]), cmap='gray', vmin=0,
                    vmax=1.5)
    ax[2, 2].set_title('K$_{shear}$')
    ax[2, 3].imshow(np.rot90(qtifit.k_mu[:, :, z]), cmap='gray', vmin=0, vmax=1.5)
    ax[2, 3].set_title('K$_{μ}$')

    fig.tight_layout()
    plt.show()








.. GENERATED FROM PYTHON SOURCE LINES 181-189

For more information about QTI, please read the article by Westin et
al. [1]_.

References
----------
.. [1] Westin, Carl-Fredrik, et al. "Q-space trajectory imaging for
   multidimensional diffusion MRI of the human brain." Neuroimage 135
   (2016): 345-362. https://doi.org/10.1016/j.neuroimage.2016.02.039.

.. GENERATED FROM PYTHON SOURCE LINES 191-193

.. include:: ../../links_names.inc



.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 55.948 seconds)


.. _sphx_glr_download_examples_built_reconstruction_reconst_qti.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: reconst_qti.ipynb <reconst_qti.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: reconst_qti.py <reconst_qti.py>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
