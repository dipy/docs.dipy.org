
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples_built\fiber_tracking\tracking_stopping_criterion.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_examples_built_fiber_tracking_tracking_stopping_criterion.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_built_fiber_tracking_tracking_stopping_criterion.py:


=================================================
Using Various Stopping Criterion for Tractography
=================================================
The stopping criterion determines if the tracking stops or continues at each
tracking position. The tracking stops when it reaches an ending region
(e.g. low FA, gray matter or corticospinal fluid regions) or exits the image
boundaries. The tracking also stops if the direction getter has no direction
to follow.

Each stopping criterion determines if the stopping is 'valid' or
'invalid'. A streamline is 'valid' when the stopping criterion determines if
the streamline stops in a position classified as 'ENDPOINT' or 'OUTSIDEIMAGE'.
A streamline is 'invalid' when it stops in a position classified as
'TRACKPOINT' or 'INVALIDPOINT'. These conditions are described below. The
'LocalTracking' generator can be set to output all generated streamlines
or only the 'valid' ones. See Girard et al. (2004) [Girard2014]_ and Smith et
al.(2012) [Smith2012]_ for more details on these methods.

This example is an extension of the
:ref:`sphx_glr_examples_built_fiber_tracking_tracking_deterministic.py`
example. We begin by loading the data, creating a seeding mask from white
matter voxels of the corpus callosum, fitting a Constrained Spherical
Deconvolution (CSD) reconstruction model and creating the maximum
deterministic direction getter.

.. GENERATED FROM PYTHON SOURCE LINES 27-76

.. code-block:: Python


    import matplotlib.pyplot as plt
    import numpy as np

    from dipy.core.gradients import gradient_table
    from dipy.data import get_fnames, default_sphere
    from dipy.direction import DeterministicMaximumDirectionGetter
    from dipy.io.gradients import read_bvals_bvecs
    from dipy.io.image import load_nifti, load_nifti_data
    from dipy.io.streamline import save_trk
    from dipy.io.stateful_tractogram import Space, StatefulTractogram
    from dipy.reconst.csdeconv import (ConstrainedSphericalDeconvModel,
                                       auto_response_ssst)
    from dipy.reconst.dti import fractional_anisotropy, TensorModel
    from dipy.tracking import utils
    from dipy.tracking.local_tracking import LocalTracking
    from dipy.tracking.streamline import Streamlines
    from dipy.tracking.stopping_criterion import (ActStoppingCriterion,
                                                  BinaryStoppingCriterion,
                                                  ThresholdStoppingCriterion)
    from dipy.viz import window, actor, colormap, has_fury


    # Enables/disables interactive visualization
    interactive = False

    hardi_fname, hardi_bval_fname, hardi_bvec_fname = get_fnames('stanford_hardi')
    label_fname = get_fnames('stanford_labels')
    _, _, f_pve_wm = get_fnames('stanford_pve_maps')

    data, affine, hardi_img = load_nifti(hardi_fname, return_img=True)
    labels = load_nifti_data(label_fname)
    bvals, bvecs = read_bvals_bvecs(hardi_bval_fname, hardi_bvec_fname)
    gtab = gradient_table(bvals, bvecs)

    white_matter = load_nifti_data(f_pve_wm)

    seed_mask = (labels == 2)
    seed_mask[white_matter < 0.5] = 0
    seeds = utils.seeds_from_mask(seed_mask, affine, density=2)

    response, ratio = auto_response_ssst(gtab, data, roi_radii=10, fa_thr=0.7)
    csd_model = ConstrainedSphericalDeconvModel(gtab, response)
    csd_fit = csd_model.fit(data, mask=white_matter)

    dg = DeterministicMaximumDirectionGetter.from_shcoeff(csd_fit.shm_coeff,
                                                          max_angle=30.,
                                                          sphere=default_sphere)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|                                                                                                                                               | 0/77848.12 [00:00<?, ?it/s]      0%|▌                                                                                                                                  | 320/77848.12 [00:00<00:24, 3185.27it/s]      1%|█▏                                                                                                                                 | 701/77848.12 [00:00<00:21, 3543.33it/s]      1%|█▊                                                                                                                                | 1103/77848.12 [00:00<00:20, 3753.17it/s]      2%|██▍                                                                                                                               | 1479/77848.12 [00:00<00:20, 3689.46it/s]      2%|███                                                                                                                               | 1849/77848.12 [00:00<00:20, 3624.26it/s]      3%|███▋                                                                                                                              | 2212/77848.12 [00:00<00:20, 3615.66it/s]      3%|████▎                                                                                                                             | 2617/77848.12 [00:00<00:20, 3751.40it/s]      4%|█████                                                                                                                             | 3029/77848.12 [00:00<00:19, 3862.12it/s]      4%|█████▊                                                                                                                            | 3447/77848.12 [00:00<00:18, 3950.08it/s]      5%|██████▍                                                                                                                           | 3884/77848.12 [00:01<00:18, 4074.16it/s]      6%|███████▏                                                                                                                          | 4293/77848.12 [00:01<00:18, 4073.70it/s]      6%|███████▉                                                                                                                          | 4722/77848.12 [00:01<00:17, 4134.04it/s]      7%|████████▋                                                                                                                         | 5181/77848.12 [00:01<00:17, 4263.17it/s]      7%|█████████▎                                                                                                                        | 5608/77848.12 [00:01<00:17, 4222.46it/s]      8%|██████████                                                                                                                        | 6056/77848.12 [00:01<00:16, 4293.57it/s]      8%|██████████▊                                                                                                                       | 6486/77848.12 [00:01<00:16, 4253.44it/s]      9%|███████████▌                                                                                                                      | 6954/77848.12 [00:01<00:16, 4373.18it/s]     10%|████████████▎                                                                                                                     | 7406/77848.12 [00:01<00:15, 4411.92it/s]     10%|█████████████                                                                                                                     | 7848/77848.12 [00:01<00:15, 4382.22it/s]     11%|█████████████▊                                                                                                                    | 8297/77848.12 [00:02<00:15, 4408.42it/s]     11%|██████████████▋                                                                                                                   | 8759/77848.12 [00:02<00:15, 4464.42it/s]     12%|███████████████▎                                                                                                                  | 9206/77848.12 [00:02<00:15, 4421.63it/s]     12%|████████████████▏                                                                                                                 | 9666/77848.12 [00:02<00:15, 4473.74it/s]     13%|████████████████▊                                                                                                                | 10121/77848.12 [00:02<00:15, 4492.21it/s]     14%|█████████████████▌                                                                                                               | 10571/77848.12 [00:02<00:14, 4488.15it/s]     14%|██████████████████▎                                                                                                              | 11035/77848.12 [00:02<00:14, 4527.93it/s]     15%|███████████████████                                                                                                              | 11502/77848.12 [00:02<00:14, 4564.72it/s]     15%|███████████████████▊                                                                                                             | 11959/77848.12 [00:02<00:14, 4493.32it/s]     16%|████████████████████▌                                                                                                            | 12442/77848.12 [00:02<00:14, 4586.79it/s]     17%|█████████████████████▍                                                                                                           | 12916/77848.12 [00:03<00:14, 4627.96it/s]     17%|██████████████████████▏                                                                                                          | 13380/77848.12 [00:03<00:14, 4528.34it/s]     18%|██████████████████████▉                                                                                                          | 13872/77848.12 [00:03<00:13, 4634.14it/s]     18%|███████████████████████▊                                                                                                         | 14363/77848.12 [00:03<00:13, 4707.75it/s]     19%|████████████████████████▌                                                                                                        | 14835/77848.12 [00:03<00:13, 4585.09it/s]     20%|█████████████████████████▎                                                                                                       | 15300/77848.12 [00:03<00:13, 4599.16it/s]     20%|██████████████████████████▏                                                                                                      | 15777/77848.12 [00:03<00:13, 4643.70it/s]     21%|██████████████████████████▉                                                                                                      | 16246/77848.12 [00:03<00:13, 4644.82it/s]     21%|███████████████████████████▋                                                                                                     | 16711/77848.12 [00:03<00:13, 4559.19it/s]     22%|████████████████████████████▍                                                                                                    | 17178/77848.12 [00:03<00:13, 4587.38it/s]     23%|█████████████████████████████▏                                                                                                   | 17638/77848.12 [00:04<00:13, 4587.08it/s]     23%|█████████████████████████████▉                                                                                                   | 18103/77848.12 [00:04<00:12, 4601.45it/s]     24%|██████████████████████████████▊                                                                                                  | 18564/77848.12 [00:04<00:13, 4545.99it/s]     24%|███████████████████████████████▌                                                                                                 | 19054/77848.12 [00:04<00:12, 4644.90it/s]     25%|████████████████████████████████▎                                                                                                | 19527/77848.12 [00:04<00:12, 4663.04it/s]     26%|█████████████████████████████████▏                                                                                               | 20000/77848.12 [00:04<00:12, 4678.43it/s]     26%|█████████████████████████████████▉                                                                                               | 20469/77848.12 [00:04<00:12, 4676.07it/s]     27%|██████████████████████████████████▋                                                                                              | 20941/77848.12 [00:04<00:12, 4685.56it/s]     28%|███████████████████████████████████▍                                                                                             | 21418/77848.12 [00:04<00:11, 4709.26it/s]     28%|████████████████████████████████████▎                                                                                            | 21889/77848.12 [00:04<00:11, 4704.07it/s]     29%|█████████████████████████████████████                                                                                            | 22360/77848.12 [00:05<00:11, 4630.17it/s]     29%|█████████████████████████████████████▊                                                                                           | 22835/77848.12 [00:05<00:11, 4659.30it/s]     30%|██████████████████████████████████████▋                                                                                          | 23319/77848.12 [00:05<00:11, 4708.00it/s]     31%|███████████████████████████████████████▍                                                                                         | 23790/77848.12 [00:05<00:11, 4704.42it/s]     31%|████████████████████████████████████████▏                                                                                        | 24261/77848.12 [00:05<00:11, 4603.49it/s]     32%|█████████████████████████████████████████                                                                                        | 24757/77848.12 [00:05<00:11, 4702.86it/s]     32%|█████████████████████████████████████████▊                                                                                       | 25243/77848.12 [00:05<00:11, 4741.45it/s]     33%|██████████████████████████████████████████▌                                                                                      | 25718/77848.12 [00:05<00:11, 4709.44it/s]     34%|███████████████████████████████████████████▍                                                                                     | 26190/77848.12 [00:05<00:11, 4638.15it/s]     34%|████████████████████████████████████████████▏                                                                                    | 26689/77848.12 [00:05<00:10, 4735.53it/s]     35%|█████████████████████████████████████████████                                                                                    | 27170/77848.12 [00:06<00:10, 4751.62it/s]     36%|█████████████████████████████████████████████▊                                                                                   | 27646/77848.12 [00:06<00:10, 4749.33it/s]     36%|██████████████████████████████████████████████▌                                                                                  | 28122/77848.12 [00:06<00:10, 4701.07it/s]     37%|███████████████████████████████████████████████▍                                                                                 | 28593/77848.12 [00:06<00:10, 4683.88it/s]     37%|████████████████████████████████████████████████▏                                                                                | 29065/77848.12 [00:06<00:10, 4688.73it/s]     38%|████████████████████████████████████████████████▉                                                                                | 29534/77848.12 [00:06<00:10, 4668.75it/s]     39%|█████████████████████████████████████████████████▋                                                                               | 30009/77848.12 [00:06<00:10, 4686.87it/s]     39%|██████████████████████████████████████████████████▌                                                                              | 30478/77848.12 [00:06<00:10, 4639.74it/s]     40%|███████████████████████████████████████████████████▎                                                                             | 30968/77848.12 [00:06<00:09, 4711.98it/s]     40%|████████████████████████████████████████████████████                                                                             | 31440/77848.12 [00:07<00:09, 4712.86it/s]     41%|████████████████████████████████████████████████████▉                                                                            | 31916/77848.12 [00:07<00:09, 4721.10it/s]     42%|█████████████████████████████████████████████████████▋                                                                           | 32404/77848.12 [00:07<00:09, 4760.37it/s]     42%|██████████████████████████████████████████████████████▍                                                                          | 32881/77848.12 [00:07<00:09, 4699.99it/s]     43%|███████████████████████████████████████████████████████▎                                                                         | 33368/77848.12 [00:07<00:09, 4743.78it/s]     43%|████████████████████████████████████████████████████████                                                                         | 33851/77848.12 [00:07<00:09, 4763.55it/s]     44%|████████████████████████████████████████████████████████▉                                                                        | 34328/77848.12 [00:07<00:09, 4744.30it/s]     45%|█████████████████████████████████████████████████████████▋                                                                       | 34803/77848.12 [00:07<00:09, 4741.00it/s]     45%|██████████████████████████████████████████████████████████▍                                                                      | 35284/77848.12 [00:07<00:08, 4756.48it/s]     46%|███████████████████████████████████████████████████████████▎                                                                     | 35764/77848.12 [00:07<00:08, 4762.35it/s]     47%|████████████████████████████████████████████████████████████                                                                     | 36249/77848.12 [00:08<00:08, 4784.20it/s]     47%|████████████████████████████████████████████████████████████▊                                                                    | 36735/77848.12 [00:08<00:08, 4800.48it/s]     48%|█████████████████████████████████████████████████████████████▋                                                                   | 37216/77848.12 [00:08<00:08, 4727.56it/s]     48%|██████████████████████████████████████████████████████████████▍                                                                  | 37695/77848.12 [00:08<00:08, 4739.98it/s]     49%|███████████████████████████████████████████████████████████████▎                                                                 | 38170/77848.12 [00:08<00:08, 4738.28it/s]     50%|████████████████████████████████████████████████████████████████                                                                 | 38644/77848.12 [00:08<00:08, 4637.45it/s]     50%|████████████████████████████████████████████████████████████████▊                                                                | 39127/77848.12 [00:08<00:08, 4687.85it/s]     51%|█████████████████████████████████████████████████████████████████▌                                                               | 39597/77848.12 [00:08<00:08, 4656.92it/s]     51%|██████████████████████████████████████████████████████████████████▍                                                              | 40071/77848.12 [00:08<00:08, 4675.91it/s]     52%|███████████████████████████████████████████████████████████████████▏                                                             | 40539/77848.12 [00:08<00:08, 4641.90it/s]     53%|███████████████████████████████████████████████████████████████████▉                                                             | 41004/77848.12 [00:09<00:07, 4638.58it/s]     53%|████████████████████████████████████████████████████████████████████▋                                                            | 41468/77848.12 [00:09<00:08, 4520.72it/s]     54%|█████████████████████████████████████████████████████████████████████▍                                                           | 41929/77848.12 [00:09<00:07, 4540.82it/s]     54%|██████████████████████████████████████████████████████████████████████▏                                                          | 42392/77848.12 [00:09<00:07, 4561.79it/s]     55%|███████████████████████████████████████████████████████████████████████                                                          | 42849/77848.12 [00:09<00:07, 4557.88it/s]     56%|███████████████████████████████████████████████████████████████████████▊                                                         | 43306/77848.12 [00:09<00:07, 4543.72it/s]     56%|████████████████████████████████████████████████████████████████████████▌                                                        | 43761/77848.12 [00:09<00:07, 4446.77it/s]     57%|█████████████████████████████████████████████████████████████████████████▎                                                       | 44207/77848.12 [00:09<00:07, 4406.95it/s]     57%|█████████████████████████████████████████████████████████████████████████▉                                                       | 44649/77848.12 [00:09<00:07, 4394.15it/s]     58%|██████████████████████████████████████████████████████████████████████████▋                                                      | 45089/77848.12 [00:09<00:07, 4326.94it/s]     59%|███████████████████████████████████████████████████████████████████████████▍                                                     | 45547/77848.12 [00:10<00:07, 4389.12it/s]     59%|████████████████████████████████████████████████████████████████████████████▏                                                    | 45987/77848.12 [00:10<00:07, 4361.44it/s]     60%|████████████████████████████████████████████████████████████████████████████▉                                                    | 46424/77848.12 [00:10<00:07, 4259.06it/s]     60%|█████████████████████████████████████████████████████████████████████████████▋                                                   | 46853/77848.12 [00:10<00:07, 4261.63it/s]     61%|██████████████████████████████████████████████████████████████████████████████▎                                                  | 47280/77848.12 [00:10<00:07, 4258.97it/s]     61%|███████████████████████████████████████████████████████████████████████████████                                                  | 47723/77848.12 [00:10<00:07, 4302.35it/s]     62%|███████████████████████████████████████████████████████████████████████████████▊                                                 | 48176/77848.12 [00:10<00:06, 4364.71it/s]     62%|████████████████████████████████████████████████████████████████████████████████▌                                                | 48613/77848.12 [00:10<00:06, 4322.90it/s]     63%|█████████████████████████████████████████████████████████████████████████████████▎                                               | 49060/77848.12 [00:10<00:06, 4360.44it/s]     64%|██████████████████████████████████████████████████████████████████████████████████                                               | 49497/77848.12 [00:10<00:06, 4281.50it/s]     64%|██████████████████████████████████████████████████████████████████████████████████▋                                              | 49926/77848.12 [00:11<00:06, 4278.80it/s]     65%|███████████████████████████████████████████████████████████████████████████████████▍                                             | 50382/77848.12 [00:11<00:06, 4356.28it/s]     65%|████████████████████████████████████████████████████████████████████████████████████▏                                            | 50818/77848.12 [00:11<00:06, 4351.31it/s]     66%|████████████████████████████████████████████████████████████████████████████████████▉                                            | 51261/77848.12 [00:11<00:06, 4366.94it/s]     66%|█████████████████████████████████████████████████████████████████████████████████████▋                                           | 51698/77848.12 [00:11<00:06, 4299.19it/s]     67%|██████████████████████████████████████████████████████████████████████████████████████▍                                          | 52152/77848.12 [00:11<00:05, 4363.79it/s]     68%|███████████████████████████████████████████████████████████████████████████████████████▏                                         | 52623/77848.12 [00:11<00:05, 4462.86it/s]     68%|███████████████████████████████████████████████████████████████████████████████████████▉                                         | 53072/77848.12 [00:11<00:05, 4460.66it/s]     69%|████████████████████████████████████████████████████████████████████████████████████████▊                                        | 53561/77848.12 [00:11<00:05, 4581.42it/s]     69%|█████████████████████████████████████████████████████████████████████████████████████████▌                                       | 54038/77848.12 [00:11<00:05, 4631.50it/s]     70%|██████████████████████████████████████████████████████████████████████████████████████████▎                                      | 54502/77848.12 [00:12<00:05, 4627.21it/s]     71%|███████████████████████████████████████████████████████████████████████████████████████████                                      | 54965/77848.12 [00:12<00:05, 4567.76it/s]     71%|███████████████████████████████████████████████████████████████████████████████████████████▉                                     | 55463/77848.12 [00:12<00:04, 4683.71it/s]     72%|████████████████████████████████████████████████████████████████████████████████████████████▋                                    | 55945/77848.12 [00:12<00:04, 4710.53it/s]     72%|█████████████████████████████████████████████████████████████████████████████████████████████▍                                   | 56417/77848.12 [00:12<00:04, 4429.06it/s]     73%|██████████████████████████████████████████████████████████████████████████████████████████████▎                                  | 56901/77848.12 [00:12<00:04, 4541.05it/s]     74%|███████████████████████████████████████████████████████████████████████████████████████████████                                  | 57359/77848.12 [00:12<00:04, 4551.10it/s]     74%|███████████████████████████████████████████████████████████████████████████████████████████████▊                                 | 57851/77848.12 [00:12<00:04, 4653.89it/s]     75%|████████████████████████████████████████████████████████████████████████████████████████████████▋                                | 58324/77848.12 [00:12<00:04, 4669.83it/s]     76%|█████████████████████████████████████████████████████████████████████████████████████████████████▍                               | 58806/77848.12 [00:13<00:04, 4708.15it/s]     76%|██████████████████████████████████████████████████████████████████████████████████████████████████▏                              | 59278/77848.12 [00:13<00:03, 4691.27it/s]     77%|███████████████████████████████████████████████████████████████████████████████████████████████████                              | 59748/77848.12 [00:13<00:03, 4621.84it/s]     77%|███████████████████████████████████████████████████████████████████████████████████████████████████▊                             | 60259/77848.12 [00:13<00:03, 4758.87it/s]     78%|████████████████████████████████████████████████████████████████████████████████████████████████████▋                            | 60736/77848.12 [00:13<00:03, 4727.72it/s]     79%|█████████████████████████████████████████████████████████████████████████████████████████████████████▍                           | 61210/77848.12 [00:13<00:03, 4725.03it/s]     79%|██████████████████████████████████████████████████████████████████████████████████████████████████████▏                          | 61694/77848.12 [00:13<00:03, 4754.04it/s]     80%|███████████████████████████████████████████████████████████████████████████████████████████████████████                          | 62170/77848.12 [00:13<00:03, 4721.39it/s]     81%|███████████████████████████████████████████████████████████████████████████████████████████████████████▊                         | 62674/77848.12 [00:13<00:03, 4810.53it/s]     81%|████████████████████████████████████████████████████████████████████████████████████████████████████████▋                        | 63169/77848.12 [00:13<00:03, 4838.67it/s]     82%|█████████████████████████████████████████████████████████████████████████████████████████████████████████▍                       | 63654/77848.12 [00:14<00:02, 4818.83it/s]     82%|██████████████████████████████████████████████████████████████████████████████████████████████████████████▎                      | 64139/77848.12 [00:14<00:02, 4822.44it/s]     83%|███████████████████████████████████████████████████████████████████████████████████████████████████████████                      | 64622/77848.12 [00:14<00:02, 4821.07it/s]     84%|███████████████████████████████████████████████████████████████████████████████████████████████████████████▉                     | 65118/77848.12 [00:14<00:02, 4862.41it/s]     84%|████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                    | 65605/77848.12 [00:14<00:02, 4860.83it/s]     85%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                   | 66092/77848.12 [00:14<00:02, 4784.51it/s]     86%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                  | 66571/77848.12 [00:14<00:02, 4726.04it/s]     86%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                 | 67092/77848.12 [00:14<00:02, 4855.14it/s]     87%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████▉                 | 67581/77848.12 [00:14<00:02, 4857.46it/s]     87%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                | 68068/77848.12 [00:14<00:02, 4841.89it/s]     88%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌               | 68553/77848.12 [00:15<00:01, 4822.49it/s]     89%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍              | 69036/77848.12 [00:15<00:01, 4749.68it/s]     89%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏             | 69549/77848.12 [00:15<00:01, 4859.66it/s]     90%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████             | 70038/77848.12 [00:15<00:01, 4862.94it/s]     91%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊            | 70525/77848.12 [00:15<00:01, 4745.88it/s]     91%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋           | 71001/77848.12 [00:15<00:01, 4716.64it/s]     92%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍          | 71474/77848.12 [00:15<00:01, 4666.30it/s]     92%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏         | 71964/77848.12 [00:15<00:01, 4730.19it/s]     93%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████         | 72438/77848.12 [00:15<00:01, 4699.33it/s]     94%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊        | 72916/77848.12 [00:15<00:01, 4718.18it/s]     94%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌       | 73389/77848.12 [00:16<00:00, 4580.59it/s]     95%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍      | 73894/77848.12 [00:16<00:00, 4710.99it/s]     96%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏     | 74371/77848.12 [00:16<00:00, 4721.56it/s]     96%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████     | 74851/77848.12 [00:16<00:00, 4738.81it/s]     97%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊    | 75326/77848.12 [00:16<00:00, 4641.53it/s]     97%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌   | 75791/77848.12 [00:16<00:00, 4624.77it/s]     98%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍  | 76266/77848.12 [00:16<00:00, 4656.74it/s]     99%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏ | 76735/77848.12 [00:16<00:00, 4660.25it/s]     99%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▉ | 77202/77848.12 [00:16<00:00, 4582.83it/s]    100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊| 77721/77848.12 [00:17<00:00, 4753.23it/s]    78197it [00:17, 4735.13it/s]                                                                                                                                                         78671it [00:17, 4729.12it/s]    79145it [00:17, 4657.30it/s]    79683it [00:17, 4864.24it/s]    80171it [00:17, 4821.55it/s]    80654it [00:17, 4817.48it/s]    81137it [00:17, 4690.07it/s]    81649it [00:17, 4809.80it/s]    82131it [00:17, 4798.93it/s]    82612it [00:18, 4796.50it/s]    83093it [00:18, 4683.89it/s]    83593it [00:18, 4769.40it/s]    84071it [00:18, 4769.89it/s]    84549it [00:18, 4634.80it/s]    85014it [00:18, 4478.00it/s]    85493it [00:18, 4560.62it/s]    85955it [00:18, 4571.53it/s]    86414it [00:18, 4513.98it/s]    86904it [00:18, 4621.93it/s]    87367it [00:19, 4579.33it/s]    87826it [00:19, 4510.34it/s]    88310it [00:19, 4599.18it/s]    88771it [00:19, 4463.80it/s]    89219it [00:19, 4336.90it/s]    89681it [00:19, 4411.14it/s]    90124it [00:19, 4373.57it/s]    90593it [00:19, 4458.12it/s]    91040it [00:19, 4416.24it/s]    91497it [00:20, 4450.50it/s]    91943it [00:20, 4422.55it/s]    92386it [00:20, 4355.12it/s]    92834it [00:20, 4386.07it/s]    93273it [00:20, 4254.75it/s]    93717it [00:20, 4302.61it/s]    94149it [00:20, 4168.23it/s]    94585it [00:20, 4217.22it/s]    95008it [00:20, 4150.42it/s]    95424it [00:20, 4133.64it/s]    95838it [00:21, 4070.12it/s]    96246it [00:21, 3987.78it/s]    96646it [00:21, 3951.50it/s]    96989it [00:21, 4538.50it/s]




.. GENERATED FROM PYTHON SOURCE LINES 77-101

Threshold Stopping Criterion
============================
A scalar map can be used to define where the tracking stops. The threshold
stopping criterion uses a scalar map to stop the tracking whenever the
interpolated scalar value is lower than a fixed threshold. Here, we show
an example using the fractional anisotropy (FA) map of the DTI model.
The threshold stopping criterion uses a trilinear interpolation at the
tracking position.

**Parameters**

- metric_map: numpy array [:, :, :]
- threshold: float

**Stopping States**

- 'ENDPOINT': stops at a position where metric_map < threshold; the
streamline reached the target stopping area.
- 'OUTSIDEIMAGE': stops at a position outside of metric_map; the streamline
reached an area outside the image where no direction data is available.
- 'TRACKPOINT': stops at a position because no direction is available; the
streamline is stopping where metric_map >= threshold, but there is no valid
direction to follow.
- 'INVALIDPOINT': N/A.

.. GENERATED FROM PYTHON SOURCE LINES 101-118

.. code-block:: Python


    tensor_model = TensorModel(gtab)
    tenfit = tensor_model.fit(data, mask=labels > 0)
    FA = fractional_anisotropy(tenfit.evals)

    threshold_criterion = ThresholdStoppingCriterion(FA, .2)

    fig = plt.figure()
    mask_fa = FA.copy()
    mask_fa[mask_fa < 0.2] = 0
    plt.xticks([])
    plt.yticks([])
    plt.imshow(mask_fa[:, :, data.shape[2] // 2].T, cmap='gray', origin='lower',
               interpolation='nearest')
    fig.tight_layout()
    fig.savefig('threshold_fa.png')




.. image-sg:: /examples_built/fiber_tracking/images/sphx_glr_tracking_stopping_criterion_001.png
   :alt: tracking stopping criterion
   :srcset: /examples_built/fiber_tracking/images/sphx_glr_tracking_stopping_criterion_001.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 119-122

.. rst-class:: centered small fst-italic fw-semibold

Thresholded fractional anisotropy map.

.. GENERATED FROM PYTHON SOURCE LINES 122-141

.. code-block:: Python


    streamline_generator = LocalTracking(dg,
                                         threshold_criterion,
                                         seeds,
                                         affine,
                                         step_size=.5,
                                         return_all=True)
    streamlines = Streamlines(streamline_generator)
    sft = StatefulTractogram(streamlines, hardi_img, Space.RASMM)
    save_trk(sft, "tractogram_probabilistic_thresh_all.trk")

    if has_fury:
        scene = window.Scene()
        scene.add(actor.line(streamlines, colormap.line_colors(streamlines)))
        window.record(scene, out_path='tractogram_deterministic_thresh_all.png',
                      size=(800, 800))
        if interactive:
            window.show(scene)




.. image-sg:: /examples_built/fiber_tracking/images/sphx_glr_tracking_stopping_criterion_002.png
   :alt: tracking stopping criterion
   :srcset: /examples_built/fiber_tracking/images/sphx_glr_tracking_stopping_criterion_002.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 142-171

.. rst-class:: centered small fst-italic fw-semibold

 Corpus Callosum using deterministic tractography with a thresholded
 fractional anisotropy mask.



Binary Stopping Criterion
=========================
A binary mask can be used to define where the tracking stops. The binary
stopping criterion stops the tracking whenever the tracking position is
outside the mask. Here, we show how to obtain the binary stopping criterion
from the white matter mask defined above. The binary stopping criterion uses
a nearest-neighborhood interpolation at the tracking position.

**Parameters**

- mask: numpy array [:, :, :]

**Stopping States**

- 'ENDPOINT': stops at a position where mask = 0; the streamline
reached the target stopping area.
- 'OUTSIDEIMAGE': stops at a position outside of metric_map; the streamline
reached an area outside the image where no direction data is available.
- 'TRACKPOINT': stops at a position because no direction is available; the
streamline is stopping where mask > 0, but there is no valid direction to
follow.
- 'INVALIDPOINT': N/A.

.. GENERATED FROM PYTHON SOURCE LINES 171-183

.. code-block:: Python


    binary_criterion = BinaryStoppingCriterion(white_matter == 1)

    fig = plt.figure()
    plt.xticks([])
    plt.yticks([])
    fig.tight_layout()
    plt.imshow(white_matter[:, :, data.shape[2] // 2].T, cmap='gray',
               origin='lower', interpolation='nearest')

    fig.savefig('white_matter_mask.png')




.. image-sg:: /examples_built/fiber_tracking/images/sphx_glr_tracking_stopping_criterion_003.png
   :alt: tracking stopping criterion
   :srcset: /examples_built/fiber_tracking/images/sphx_glr_tracking_stopping_criterion_003.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 184-187

.. rst-class:: centered small fst-italic fw-semibold

White matter binary mask.

.. GENERATED FROM PYTHON SOURCE LINES 187-206

.. code-block:: Python


    streamline_generator = LocalTracking(dg,
                                         binary_criterion,
                                         seeds,
                                         affine,
                                         step_size=.5,
                                         return_all=True)
    streamlines = Streamlines(streamline_generator)
    sft = StatefulTractogram(streamlines, hardi_img, Space.RASMM)
    save_trk(sft, "tractogram_deterministic_binary_all.trk")

    if has_fury:
        scene = window.Scene()
        scene.add(actor.line(streamlines, colormap.line_colors(streamlines)))
        window.record(scene, out_path='tractogram_deterministic_binary_all.png',
                      size=(800, 800))
        if interactive:
            window.show(scene)




.. image-sg:: /examples_built/fiber_tracking/images/sphx_glr_tracking_stopping_criterion_004.png
   :alt: tracking stopping criterion
   :srcset: /examples_built/fiber_tracking/images/sphx_glr_tracking_stopping_criterion_004.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 207-243

.. rst-class:: centered small fst-italic fw-semibold

Corpus Callosum using deterministic tractography with a binary white
 matter mask.



ACT Stopping Criterion
======================
Anatomically-constrained tractography (ACT) [Smith2012]_ uses information
from anatomical images to determine when the tractography stops. The
``include_map`` defines when the streamline reached a 'valid' stopping
region (e.g. gray matter partial volume estimation (PVE) map) and the
``exclude_map`` defines when the streamline reached an 'invalid' stopping
region (e.g. corticospinal fluid PVE map). The background of the anatomical
image should be added to the ``include_map`` to keep streamlines exiting
the brain (e.g. through the brain stem). The ACT stopping criterion uses
a trilinear interpolation at the tracking position.

**Parameters**

- ``include_map``: numpy array ``[:, :, :]``,
- ``exclude_map``: numpy array ``[:, :, :]``,

**Stopping States**

- 'ENDPOINT': stops at a position where ``include_map`` > 0.5; the streamline
reached the target stopping area.
- 'OUTSIDEIMAGE': stops at a position outside of ``include_map`` or
``exclude_map``; the streamline reached an area outside the image where no
direction data is available.
- 'TRACKPOINT': stops at a position because no direction is available; the
streamline is stopping where ``include_map`` < 0.5 and ``exclude_map`` < 0.5,
but there is no valid direction to follow.
- 'INVALIDPOINT': ``exclude_map`` > 0.5; the streamline reach a position
which is anatomically not plausible.

.. GENERATED FROM PYTHON SOURCE LINES 243-274

.. code-block:: Python


    f_pve_csf, f_pve_gm, f_pve_wm = get_fnames('stanford_pve_maps')
    pve_csf_data = load_nifti_data(f_pve_csf)
    pve_gm_data = load_nifti_data(f_pve_gm)
    pve_wm_data = load_nifti_data(f_pve_wm)

    background = np.ones(pve_gm_data.shape)
    background[(pve_gm_data + pve_wm_data + pve_csf_data) > 0] = 0

    include_map = pve_gm_data
    include_map[background > 0] = 1
    exclude_map = pve_csf_data

    act_criterion = ActStoppingCriterion(include_map, exclude_map)

    fig = plt.figure()
    plt.subplot(121)
    plt.xticks([])
    plt.yticks([])
    plt.imshow(include_map[:, :, data.shape[2] // 2].T, cmap='gray',
               origin='lower', interpolation='nearest')

    plt.subplot(122)
    plt.xticks([])
    plt.yticks([])
    plt.imshow(exclude_map[:, :, data.shape[2] // 2].T, cmap='gray',
               origin='lower', interpolation='nearest')

    fig.tight_layout()
    fig.savefig('act_maps.png')




.. image-sg:: /examples_built/fiber_tracking/images/sphx_glr_tracking_stopping_criterion_005.png
   :alt: tracking stopping criterion
   :srcset: /examples_built/fiber_tracking/images/sphx_glr_tracking_stopping_criterion_005.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 275-278

.. rst-class:: centered small fst-italic fw-semibold

Include (left) and exclude (right) maps for ACT.

.. GENERATED FROM PYTHON SOURCE LINES 278-297

.. code-block:: Python


    streamline_generator = LocalTracking(dg,
                                         act_criterion,
                                         seeds,
                                         affine,
                                         step_size=.5,
                                         return_all=True)
    streamlines = Streamlines(streamline_generator)
    sft = StatefulTractogram(streamlines, hardi_img, Space.RASMM)
    save_trk(sft, "tractogram_deterministic_act_all.trk")

    if has_fury:
        scene = window.Scene()
        scene.add(actor.line(streamlines, colormap.line_colors(streamlines)))
        window.record(scene, out_path='tractogram_deterministic_act_all.png',
                      size=(800, 800))
        if interactive:
            window.show(scene)




.. image-sg:: /examples_built/fiber_tracking/images/sphx_glr_tracking_stopping_criterion_006.png
   :alt: tracking stopping criterion
   :srcset: /examples_built/fiber_tracking/images/sphx_glr_tracking_stopping_criterion_006.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 298-302

.. rst-class:: centered small fst-italic fw-semibold

Corpus Callosum using deterministic tractography with ACT stopping
 criterion.

.. GENERATED FROM PYTHON SOURCE LINES 302-321

.. code-block:: Python


    streamline_generator = LocalTracking(dg,
                                         act_criterion,
                                         seeds,
                                         affine,
                                         step_size=.5,
                                         return_all=False)
    streamlines = Streamlines(streamline_generator)
    sft = StatefulTractogram(streamlines, hardi_img, Space.RASMM)
    save_trk(sft, "tractogram_deterministic_act_valid.trk")

    if has_fury:
        scene = window.Scene()
        scene.add(actor.line(streamlines, colormap.line_colors(streamlines)))
        window.record(scene, out_path='tractogram_deterministic_act_valid.png',
                      size=(800, 800))
        if interactive:
            window.show(scene)




.. image-sg:: /examples_built/fiber_tracking/images/sphx_glr_tracking_stopping_criterion_007.png
   :alt: tracking stopping criterion
   :srcset: /examples_built/fiber_tracking/images/sphx_glr_tracking_stopping_criterion_007.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 322-355

.. rst-class:: centered small fst-italic fw-semibold

Corpus Callosum using deterministic tractography with ACT stopping
criterion. Streamlines ending in gray matter region only.



The threshold and binary stopping criterion use respectively a scalar map
and a binary mask to stop the tracking. The ACT stopping criterion use
partial volume fraction (PVE) maps from an anatomical image to stop the
tracking. Additionally, the ACT stopping criterion determines if the
tracking stopped in expected regions (e.g. gray matter) and allows the
user to get only streamlines stopping in those regions.

Notes
-----
Currently,the proposed method that cuts streamlines going through
subcortical gray matter regions is not implemented. The
backtracking technique for streamlines reaching INVALIDPOINT is not
implemented either [Smith2012]_.


References
----------

.. [Smith2012] Smith, R. E., Tournier, J.-D., Calamante, F., & Connelly, A.
    Anatomically-constrained tractography: Improved diffusion MRI
    streamlines tractography through effective use of anatomical
    information. NeuroImage, 63(3), 1924-1938, 2012.

.. [Girard2014] Girard, G., Whittingstall, K., Deriche, R., & Descoteaux, M.
    Towards quantitative connectivity analysis: reducing tractography biases.
    NeuroImage, 98, 266-278, 2014.

.. GENERATED FROM PYTHON SOURCE LINES 357-359

.. include:: ../../links_names.inc



.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 59.866 seconds)


.. _sphx_glr_download_examples_built_fiber_tracking_tracking_stopping_criterion.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: tracking_stopping_criterion.ipynb <tracking_stopping_criterion.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: tracking_stopping_criterion.py <tracking_stopping_criterion.py>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
