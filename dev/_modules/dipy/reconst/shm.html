
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DIPY &#8212; dipy 1.11.0.dev0+git20241213.932dcbd documentation</title>
  
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/dipy.css?v=cedb193d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

  
<link rel="stylesheet" href="../../../_static/styles/grg-sphinx-theme.css"/>

    <script src="../../../_static/documentation_options.js?v=e000a0f7"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-D610GKJZRC"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D610GKJZRC');
            </script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D610GKJZRC');
            </script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/dipy/reconst/shm';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.4';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://docs.dipy.org/dev/_static/version_switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'development';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = true;
        </script>
    <link rel="icon" href="../../../_static/dipy-favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="keywords" content="DIPY, dMRI, DTI, DSI, diffusion MRI, Tensor,
  neuroimaging, python, neuroscience, Eleftherios, Garyfallidis, tractography,
  streamlines, fiber tracking">

  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
<nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
     
  

<a class="navbar-brand logo" href="https://dipy.org">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/dipy-logo.png" class="logo__image only-light" alt="DIPY"/>
    <script>document.write(`<img src="../../../_static/dipy-logo.png" class="logo__image only-dark" alt="DIPY"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  
  <ul class="bd-navbar-elements navbar-nav">
    
          <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-header-nav-more-links">
                    Docs
                </button>
                <ul id="pst-header-nav-more-links" class="dropdown-menu">
                    
      <li class="nav-item">
        <a class="nav-link" href="../../../index.html">
          Overview
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../examples_built/index.html">
          Tutorials
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../recipes.html">
          Recipes
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../interfaces/index.html">
          CLI / Workflows
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../reference/index.html">
          API
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../reference_cmd/index.html">
          CLI API
        </a>
      </li>
                </ul>
            </li>
          

          <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-header-nav-more-links">
                    Workshops
                </button>
                <ul id="pst-header-nav-more-links" class="dropdown-menu">
                    
    <li class="nav-item">
      <p class="nav-section-title nav-link">
        Latest
      </p>
    </li>

        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/workshops/dipy-workshop-2024" target="_blank">
            DIPY Workshop 2024 <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>

    <li class="nav-item">
      <p class="nav-section-title nav-link">
        Past
      </p>
    </li>

        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/workshops/dipy-workshop-2023" target="_blank">
            DIPY Workshop 2023 <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/workshops/dipy-workshop-2022" target="_blank">
            DIPY Workshop 2022 <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/workshops/dipy-workshop-2021" target="_blank">
            DIPY Workshop 2021 <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/workshops/dipy-workshop-2020" target="_blank">
            DIPY Workshop 2020 <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/workshops/dipy-workshop-2019" target="_blank">
            DIPY Workshop 2019 <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>
                </ul>
            </li>
          

          <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-header-nav-more-links">
                    Community
                </button>
                <ul id="pst-header-nav-more-links" class="dropdown-menu">
                    
    <li class="nav-item">
      <p class="nav-section-title nav-link">
        News
      </p>
    </li>

        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/calendar">
            Calendar
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="https://mail.python.org/mailman3/lists/dipy.python.org/" target="_blank">
            Newsletters <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/blog">
            Blog
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="https://www.youtube.com/c/diffusionimaginginpython" target="_blank">
            Youtube <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>

    <li class="nav-item">
      <p class="nav-section-title nav-link">
        Help
      </p>
    </li>

        <li class="nav-item">
          <a class="nav-link" href="https://app.gitter.im/#/room/%23dipy_dipy:gitter.im" target="_blank">
            Live Chat (Gitter) <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="https://github.com/dipy/dipy/discussions" target="_blank">
            Github Discussions <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>
                </ul>
            </li>
          

          <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-header-nav-more-links">
                    About
                </button>
                <ul id="pst-header-nav-more-links" class="dropdown-menu">
                    
        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/team">
            Team
          </a>
        </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../faq.html">
          FAQ
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../user_guide/mission.html">
          Mission Statement
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../stateoftheart.html">
          Releases
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../cite.html">
          Cite
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../glossary.html">
          Glossary
        </a>
      </li>
                </ul>
            </li>
          
  </ul>
  
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
      
        <div class="navbar-item">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/dipy" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/dipymri" title="Twitter/X" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter/X</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.youtube.com/c/diffusionimaginginpython" title="YouTube" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-youtube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">YouTube</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.linkedin.com/company/dipy/" title="LinkedIn" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-linkedin fa-lg" aria-hidden="true"></i>
            <span class="sr-only">LinkedIn</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  

  
</div>

</nav>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  
  <ul class="bd-navbar-elements navbar-nav">
    
          <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-header-nav-more-links">
                    Docs
                </button>
                <ul id="pst-header-nav-more-links" class="dropdown-menu">
                    
      <li class="nav-item">
        <a class="nav-link" href="../../../index.html">
          Overview
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../examples_built/index.html">
          Tutorials
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../recipes.html">
          Recipes
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../interfaces/index.html">
          CLI / Workflows
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../reference/index.html">
          API
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../reference_cmd/index.html">
          CLI API
        </a>
      </li>
                </ul>
            </li>
          

          <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-header-nav-more-links">
                    Workshops
                </button>
                <ul id="pst-header-nav-more-links" class="dropdown-menu">
                    
    <li class="nav-item">
      <p class="nav-section-title nav-link">
        Latest
      </p>
    </li>

        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/workshops/dipy-workshop-2024" target="_blank">
            DIPY Workshop 2024 <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>

    <li class="nav-item">
      <p class="nav-section-title nav-link">
        Past
      </p>
    </li>

        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/workshops/dipy-workshop-2023" target="_blank">
            DIPY Workshop 2023 <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/workshops/dipy-workshop-2022" target="_blank">
            DIPY Workshop 2022 <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/workshops/dipy-workshop-2021" target="_blank">
            DIPY Workshop 2021 <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/workshops/dipy-workshop-2020" target="_blank">
            DIPY Workshop 2020 <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/workshops/dipy-workshop-2019" target="_blank">
            DIPY Workshop 2019 <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>
                </ul>
            </li>
          

          <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-header-nav-more-links">
                    Community
                </button>
                <ul id="pst-header-nav-more-links" class="dropdown-menu">
                    
    <li class="nav-item">
      <p class="nav-section-title nav-link">
        News
      </p>
    </li>

        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/calendar">
            Calendar
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="https://mail.python.org/mailman3/lists/dipy.python.org/" target="_blank">
            Newsletters <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/blog">
            Blog
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="https://www.youtube.com/c/diffusionimaginginpython" target="_blank">
            Youtube <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>

    <li class="nav-item">
      <p class="nav-section-title nav-link">
        Help
      </p>
    </li>

        <li class="nav-item">
          <a class="nav-link" href="https://app.gitter.im/#/room/%23dipy_dipy:gitter.im" target="_blank">
            Live Chat (Gitter) <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="https://github.com/dipy/dipy/discussions" target="_blank">
            Github Discussions <i class="fa-solid fa-arrow-up-long external-icon mar-l-5"></i>
          </a>
        </li>
                </ul>
            </li>
          

          <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-header-nav-more-links">
                    About
                </button>
                <ul id="pst-header-nav-more-links" class="dropdown-menu">
                    
        <li class="nav-item">
          <a class="nav-link" href="https://dipy.org/team">
            Team
          </a>
        </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../faq.html">
          FAQ
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../user_guide/mission.html">
          Mission Statement
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../stateoftheart.html">
          Releases
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../cite.html">
          Cite
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../../../glossary.html">
          Glossary
        </a>
      </li>
                </ul>
            </li>
          
  </ul>
  
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-3"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-3"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-3"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-3">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/dipy" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/dipymri" title="Twitter/X" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter/X</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.youtube.com/c/diffusionimaginginpython" title="YouTube" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-youtube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">YouTube</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.linkedin.com/company/dipy/" title="LinkedIn" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-linkedin fa-lg" aria-hidden="true"></i>
            <span class="sr-only">LinkedIn</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../../dipy.html" class="nav-link">dipy</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">DIPY</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for dipy.reconst.shm</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Tools for using spherical harmonic models to fit diffusion data.</span>

<span class="sd">See :footcite:p:`Aganj2009`, :footcite:p:`Descoteaux2007`,</span>
<span class="sd">:footcite:p:`TristanVega2009a`, and :footcite:p:`TristanVega2010`.</span>

<span class="sd">References</span>
<span class="sd">----------</span>
<span class="sd">.. footbibliography::</span>

<span class="sd">Note about the Transpose:</span>
<span class="sd">In the literature the matrix representation of these methods is often written</span>
<span class="sd">as Y = Bx where B is some design matrix and Y and x are column vectors. In our</span>
<span class="sd">case the input data, a dwi stored as a nifti file for example, is stored as row</span>
<span class="sd">vectors (ndarrays) of the form (x, y, z, n), where n is the number of diffusion</span>
<span class="sd">directions. We could transpose and reshape the data to be (n, x*y*z), so that</span>
<span class="sd">we could directly plug it into the above equation. However, I have chosen to</span>
<span class="sd">keep the data as is and implement the relevant equations rewritten in the</span>
<span class="sd">following form: Y.T = x.T B.T, or in python syntax data = np.dot(sh_coef, B.T)</span>
<span class="sd">where data is Y.T and sh_coef is x.T.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">randint</span>
<span class="kn">import</span> <span class="nn">scipy.special</span> <span class="k">as</span> <span class="nn">sps</span>

<span class="kn">from</span> <span class="nn">dipy.core.geometry</span> <span class="kn">import</span> <span class="n">cart2sphere</span>
<span class="kn">from</span> <span class="nn">dipy.core.onetime</span> <span class="kn">import</span> <span class="n">auto_attr</span>
<span class="kn">from</span> <span class="nn">dipy.reconst.cache</span> <span class="kn">import</span> <span class="n">Cache</span>
<span class="kn">from</span> <span class="nn">dipy.reconst.odf</span> <span class="kn">import</span> <span class="n">OdfFit</span><span class="p">,</span> <span class="n">OdfModel</span>
<span class="kn">from</span> <span class="nn">dipy.testing.decorators</span> <span class="kn">import</span> <span class="n">warning_for_keywords</span>
<span class="kn">from</span> <span class="nn">dipy.utils.deprecator</span> <span class="kn">import</span> <span class="n">deprecate_with_version</span><span class="p">,</span> <span class="n">deprecated_params</span>

<span class="n">descoteaux07_legacy_msg</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;The legacy descoteaux07 SH basis uses absolute values for negative &quot;</span>
    <span class="s2">&quot;harmonic phase factors. It is outdated and will be deprecated in a &quot;</span>
    <span class="s2">&quot;future DIPY release. Consider using the new descoteaux07 basis by setting&quot;</span>
    <span class="s2">&quot;the `legacy` parameter to `False`.&quot;</span>
<span class="p">)</span>
<span class="n">tournier07_legacy_msg</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;The legacy tournier07 basis is not normalized. It is outdated and will &quot;</span>
    <span class="s2">&quot;be deprecated in a future release of DIPY. Consider using the new &quot;</span>
    <span class="s2">&quot;tournier07 basis by setting the `legacy` parameter to `False`.&quot;</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">_copydoc</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">bandit</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="k">return</span> <span class="n">bandit</span>


<div class="viewcode-block" id="forward_sdeconv_mat">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.forward_sdeconv_mat">[docs]</a>
<span class="nd">@deprecated_params</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s2">&quot;l_values&quot;</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.9&quot;</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">forward_sdeconv_mat</span><span class="p">(</span><span class="n">r_rh</span><span class="p">,</span> <span class="n">l_values</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build forward spherical deconvolution matrix</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r_rh : ndarray</span>
<span class="sd">        Rotational harmonics coefficients for the single fiber response</span>
<span class="sd">        function. Each element ``rh[i]`` is associated with spherical harmonics</span>
<span class="sd">        of order ``2*i``.</span>
<span class="sd">    l_values : ndarray</span>
<span class="sd">        The orders ($l$) of spherical harmonic function associated with each row</span>
<span class="sd">        of the deconvolution matrix. Only even orders are allowed</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    R : ndarray (N, N)</span>
<span class="sd">        Deconvolution matrix with shape (N, N)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">l_values</span> <span class="o">%</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;l_values has odd orders, expecting only even orders&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">r_rh</span><span class="p">[</span><span class="n">l_values</span> <span class="o">//</span> <span class="mi">2</span><span class="p">])</span></div>



<div class="viewcode-block" id="sh_to_rh">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.sh_to_rh">[docs]</a>
<span class="nd">@deprecated_params</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="s2">&quot;n&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">new_name</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;m_values&quot;</span><span class="p">,</span> <span class="s2">&quot;l_values&quot;</span><span class="p">],</span>
    <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.9&quot;</span><span class="p">,</span>
    <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">sh_to_rh</span><span class="p">(</span><span class="n">r_sh</span><span class="p">,</span> <span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Spherical harmonics (SH) to rotational harmonics (RH)</span>

<span class="sd">    Calculate the rotational harmonic decomposition up to</span>
<span class="sd">    harmonic phase factor ``m``, order ``l`` for an axially and antipodally</span>
<span class="sd">    symmetric function. Note that all ``m != 0`` coefficients</span>
<span class="sd">    will be ignored as axial symmetry is assumed. Hence, there</span>
<span class="sd">    will be ``(sh_order/2 + 1)`` non-zero coefficients.</span>

<span class="sd">    See :footcite:p:`Tournier2007` for further details about the method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r_sh : ndarray (N,)</span>
<span class="sd">        ndarray of SH coefficients for the single fiber response function.</span>
<span class="sd">        These coefficients must correspond to the real spherical harmonic</span>
<span class="sd">        functions produced by `shm.real_sh_descoteaux_from_index`.</span>
<span class="sd">    m_values : ndarray (N,)</span>
<span class="sd">        The phase factors ($m$) of the spherical harmonic function associated with</span>
<span class="sd">        each coefficient.</span>
<span class="sd">    l_values : ndarray (N,)</span>
<span class="sd">        The orders ($l$) of the spherical harmonic function associated with each</span>
<span class="sd">        coefficient.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    r_rh : ndarray (``(sh_order + 1)*(sh_order + 2)/2``,)</span>
<span class="sd">        Rotational harmonics coefficients representing the input `r_sh`</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    shm.real_sh_descoteaux_from_index, shm.real_sh_descoteaux</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">m_values</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="c1"># The delta function at theta = phi = 0 is known to have zero coefficients</span>
    <span class="c1"># where m != 0, therefore we need only compute the coefficients at m=0.</span>
    <span class="n">dirac_sh</span> <span class="o">=</span> <span class="n">gen_dirac</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">l_values</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">r_rh</span> <span class="o">=</span> <span class="n">r_sh</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">dirac_sh</span>
    <span class="k">return</span> <span class="n">r_rh</span></div>



<div class="viewcode-block" id="gen_dirac">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.gen_dirac">[docs]</a>
<span class="nd">@deprecated_params</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="s2">&quot;n&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">new_name</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;m_values&quot;</span><span class="p">,</span> <span class="s2">&quot;l_values&quot;</span><span class="p">],</span>
    <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.9&quot;</span><span class="p">,</span>
    <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">gen_dirac</span><span class="p">(</span><span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate Dirac delta function orientated in (theta, phi) on the sphere</span>

<span class="sd">    The spherical harmonics (SH) representation of this Dirac is returned as</span>
<span class="sd">    coefficients to spherical harmonic functions produced from ``descoteaux07``</span>
<span class="sd">    basis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m_values : ndarray (N,)</span>
<span class="sd">        The phase factors of the spherical harmonic function associated with</span>
<span class="sd">        each coefficient.</span>
<span class="sd">    l_values : ndarray (N,)</span>
<span class="sd">        The order ($l$) of the spherical harmonic function associated with each</span>
<span class="sd">        coefficient.</span>
<span class="sd">    theta : float [0, pi]</span>
<span class="sd">        The polar (colatitudinal) coordinate.</span>
<span class="sd">    phi : float [0, 2*pi]</span>
<span class="sd">        The azimuthal (longitudinal) coordinate.</span>
<span class="sd">    legacy: bool, optional</span>
<span class="sd">        If true, uses DIPY&#39;s legacy descoteaux07 implementation (where $|m|$</span>
<span class="sd">        is used for m &lt; 0). Else, implements the basis as defined in</span>
<span class="sd">        Descoteaux et al. 2007 (without the absolute value).</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    shm.real_sh_descoteaux_from_index, shm.real_sh_descoteaux</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dirac : ndarray</span>
<span class="sd">        SH coefficients representing the Dirac function. The shape of this is</span>
<span class="sd">        `(m + 2) * (m + 1) / 2`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">real_sh_descoteaux_from_index</span><span class="p">(</span><span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="n">legacy</span><span class="p">)</span></div>



<div class="viewcode-block" id="spherical_harmonics">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.spherical_harmonics">[docs]</a>
<span class="nd">@deprecated_params</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="s2">&quot;n&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">new_name</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;m_values&quot;</span><span class="p">,</span> <span class="s2">&quot;l_values&quot;</span><span class="p">],</span>
    <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.9&quot;</span><span class="p">,</span>
    <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">spherical_harmonics</span><span class="p">(</span><span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">use_scipy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute spherical harmonics.</span>

<span class="sd">    This may take scalar or array arguments. The inputs will be broadcast</span>
<span class="sd">    against each other.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m_values : array of int ``|m| &lt;= l``</span>
<span class="sd">        The phase factors ($m$) of the harmonics.</span>
<span class="sd">    l_values : array of int ``l &gt;= 0``</span>
<span class="sd">        The orders ($l$) of the harmonics.</span>
<span class="sd">    theta : float [0, 2*pi]</span>
<span class="sd">        The azimuthal (longitudinal) coordinate.</span>
<span class="sd">    phi : float [0, pi]</span>
<span class="sd">        The polar (colatitudinal) coordinate.</span>
<span class="sd">    use_scipy : bool, optional</span>
<span class="sd">        If True, use scipy implementation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    y_mn : complex float</span>
<span class="sd">        The harmonic $Y_l^m$ sampled at ``theta`` and ``phi``.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This is a faster implementation of scipy.special.sph_harm for</span>
<span class="sd">    scipy version &lt; 0.15.0. For scipy 0.15 and onwards, we use the scipy</span>
<span class="sd">    implementation of the function.</span>

<span class="sd">    The usual definitions for ``theta` and `phi`` used in DIPY are interchanged</span>
<span class="sd">    in the method definition to agree with the definitions in</span>
<span class="sd">    scipy.special.sph_harm, where `theta` represents the azimuthal coordinate</span>
<span class="sd">    and `phi` represents the polar coordinate.</span>

<span class="sd">    Although scipy uses a naming convention where ``m`` is the order and ``n``</span>
<span class="sd">    is the degree of the SH, the opposite of DIPY&#39;s, their definition for</span>
<span class="sd">    both parameters is the same as ours, with ``l &gt;= 0`` and ``|m| &lt;= l``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">use_scipy</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sps</span><span class="o">.</span><span class="n">sph_harm</span><span class="p">(</span><span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">lpmv</span><span class="p">(</span><span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">val</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">l_values</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">val</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
        <span class="mf">0.5</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">gammaln</span><span class="p">(</span><span class="n">l_values</span> <span class="o">-</span> <span class="n">m_values</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">gammaln</span><span class="p">(</span><span class="n">l_values</span> <span class="o">+</span> <span class="n">m_values</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m_values</span> <span class="o">*</span> <span class="n">theta</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val</span></div>



<div class="viewcode-block" id="real_sph_harm">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.real_sph_harm">[docs]</a>
<span class="nd">@deprecate_with_version</span><span class="p">(</span>
    <span class="s2">&quot;dipy.reconst.shm.real_sph_harm is deprecated, &quot;</span>
    <span class="s2">&quot;Please use &quot;</span>
    <span class="s2">&quot;dipy.reconst.shm.real_sh_descoteaux_from_index &quot;</span>
    <span class="s2">&quot;instead&quot;</span><span class="p">,</span>
    <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.3&quot;</span><span class="p">,</span>
    <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@deprecated_params</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="s2">&quot;n&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">new_name</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;m_values&quot;</span><span class="p">,</span> <span class="s2">&quot;l_values&quot;</span><span class="p">],</span>
    <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.9&quot;</span><span class="p">,</span>
    <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">real_sph_harm</span><span class="p">(</span><span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute real spherical harmonics.</span>

<span class="sd">    Where the real harmonic $Y_l^m$ is defined to be:</span>

<span class="sd">    .. math::</span>
<span class="sd">       :nowrap:</span>

<span class="sd">        Y_l^m =</span>
<span class="sd">        \begin{cases}</span>
<span class="sd">            \sqrt{2} * \Im(Y_l^m) \; if m &gt; 0 \\</span>
<span class="sd">            Y^0_l \; if m = 0 \\</span>
<span class="sd">            \sqrt{2} * \Re(Y_l^{|m|}) \; if m &lt; 0 \\</span>
<span class="sd">        \end{cases}</span>

<span class="sd">    This may take scalar or array arguments. The inputs will be broadcast</span>
<span class="sd">    against each other.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m_values : array of int ``|m| &lt;= l``</span>
<span class="sd">        The phase factors ($m$) of the harmonics.</span>
<span class="sd">    l_values : array of int ``l &gt;= 0``</span>
<span class="sd">        The orders ($l$) of the harmonics.</span>
<span class="sd">    theta : float [0, pi]</span>
<span class="sd">        The polar (colatitudinal) coordinate.</span>
<span class="sd">    phi : float [0, 2*pi]</span>
<span class="sd">        The azimuthal (longitudinal) coordinate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    y_mn : real float</span>
<span class="sd">        The real harmonic $Y_l^m$ sampled at `theta` and `phi`.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    scipy.special.sph_harm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">real_sh_descoteaux_from_index</span><span class="p">(</span><span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="real_sh_tournier_from_index">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.real_sh_tournier_from_index">[docs]</a>
<span class="nd">@deprecated_params</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="s2">&quot;n&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">new_name</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;m_values&quot;</span><span class="p">,</span> <span class="s2">&quot;l_values&quot;</span><span class="p">],</span>
    <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.9&quot;</span><span class="p">,</span>
    <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">real_sh_tournier_from_index</span><span class="p">(</span><span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute real spherical harmonics.</span>

<span class="sd">    The SH are computed as initially defined in :footcite:p:`Tournier2007` then</span>
<span class="sd">    updated in MRtrix3 :footcite:p:`Tournier2019`, where the real harmonic</span>
<span class="sd">    $Y_l^m$ is defined to be:</span>

<span class="sd">    .. math::</span>
<span class="sd">       :nowrap:</span>

<span class="sd">        Y_l^m =</span>
<span class="sd">        \begin{cases}</span>
<span class="sd">            \sqrt{2} * \Re(Y_l^m)  \; if m &gt; 0 \\</span>
<span class="sd">            Y^0_l \; if m = 0 \\</span>
<span class="sd">            \sqrt{2} * \Im(Y_l^{|m|}) \; if m &lt; 0 \\</span>
<span class="sd">        \end{cases}</span>

<span class="sd">    This may take scalar or array arguments. The inputs will be broadcast</span>
<span class="sd">    against each other.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m_values : array of int ``|m| &lt;= l``</span>
<span class="sd">        The phase factors ($m$) of the harmonics.</span>
<span class="sd">    l_values : array of int ``l &gt;= 0``</span>
<span class="sd">        The orders ($l$) of the harmonics.</span>
<span class="sd">    theta : float [0, pi]</span>
<span class="sd">        The polar (colatitudinal) coordinate.</span>
<span class="sd">    phi : float [0, 2*pi]</span>
<span class="sd">        The azimuthal (longitudinal) coordinate.</span>
<span class="sd">    legacy: bool, optional</span>
<span class="sd">        If true, uses MRtrix 0.2 SH basis definition, where the ``sqrt(2)``</span>
<span class="sd">        factor is omitted. Else, uses the MRtrix 3 definition presented above.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    real_sh : real float</span>
<span class="sd">        The real harmonics $Y_l^m$ sampled at ``theta`` and ``phi``.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># In the m &lt; 0 case, Tournier basis considers |m|</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">spherical_harmonics</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m_values</span><span class="p">),</span> <span class="n">l_values</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
    <span class="n">real_sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_values</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sh</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">sh</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">legacy</span><span class="p">:</span>
        <span class="c1"># The Tournier basis from MRtrix3 is normalized</span>
        <span class="n">real_sh</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_values</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="n">tournier07_legacy_msg</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">PendingDeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">real_sh</span></div>



<div class="viewcode-block" id="real_sh_descoteaux_from_index">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.real_sh_descoteaux_from_index">[docs]</a>
<span class="nd">@deprecated_params</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="s2">&quot;n&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">new_name</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;m_values&quot;</span><span class="p">,</span> <span class="s2">&quot;l_values&quot;</span><span class="p">],</span>
    <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.9&quot;</span><span class="p">,</span>
    <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">real_sh_descoteaux_from_index</span><span class="p">(</span><span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute real spherical harmonics.</span>

<span class="sd">    The definition adopted here follows :footcite:p:`Descoteaux2007`, where the</span>
<span class="sd">    real harmonic $Y_l^m$ is defined to be:</span>

<span class="sd">    .. math::</span>
<span class="sd">       :nowrap:</span>

<span class="sd">        Y_l^m =</span>
<span class="sd">        \begin{cases}</span>
<span class="sd">            \sqrt{2} * \Im(Y_l^m) \; if m &gt; 0 \\</span>
<span class="sd">            Y^0_l \; if m = 0 \\</span>
<span class="sd">            \sqrt{2} * \Re(Y_l^m)  \; if m &lt; 0 \\</span>
<span class="sd">        \end{cases}</span>

<span class="sd">    This may take scalar or array arguments. The inputs will be broadcast</span>
<span class="sd">    against each other.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m_values : array of int ``|m| &lt;= l``</span>
<span class="sd">        The phase factors ($m$) of the harmonics.</span>
<span class="sd">    l_values : array of int ``l &gt;= 0``</span>
<span class="sd">        The orders ($l$) of the harmonics.</span>
<span class="sd">    theta : float [0, pi]</span>
<span class="sd">        The polar (colatitudinal) coordinate.</span>
<span class="sd">    phi : float [0, 2*pi]</span>
<span class="sd">        The azimuthal (longitudinal) coordinate.</span>
<span class="sd">    legacy: bool, optional</span>
<span class="sd">        If true, uses DIPY&#39;s legacy descoteaux07 implementation (where $|m|$</span>
<span class="sd">        is used for m &lt; 0). Else, implements the basis as defined in</span>
<span class="sd">        Descoteaux et al. 2007 (without the absolute value).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    real_sh : real float</span>
<span class="sd">        The real harmonic $Y_l^m$ sampled at ``theta`` and ``phi``.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">legacy</span><span class="p">:</span>
        <span class="c1"># In the case where m &lt; 0, legacy descoteaux basis considers |m|</span>
        <span class="n">warn</span><span class="p">(</span><span class="n">descoteaux07_legacy_msg</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">PendingDeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">spherical_harmonics</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m_values</span><span class="p">),</span> <span class="n">l_values</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># In the cited paper, the basis is defined without the absolute value</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">spherical_harmonics</span><span class="p">(</span><span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>

    <span class="n">real_sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sh</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">sh</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="n">real_sh</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_values</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">real_sh</span></div>



<div class="viewcode-block" id="real_sh_tournier">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.real_sh_tournier">[docs]</a>
<span class="nd">@deprecated_params</span><span class="p">(</span><span class="s2">&quot;sh_order&quot;</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s2">&quot;sh_order_max&quot;</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.9&quot;</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">)</span>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">real_sh_tournier</span><span class="p">(</span><span class="n">sh_order_max</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">full_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute real spherical harmonics.</span>

<span class="sd">    The SH are computed as initially defined in :footcite:p:`Tournier2007` then</span>
<span class="sd">    updated in MRtrix3 :footcite:p:`Tournier2019`, where the real harmonic</span>
<span class="sd">    $Y_l^m$ is defined to be:</span>

<span class="sd">    .. math::</span>
<span class="sd">       :nowrap:</span>

<span class="sd">        Y_l^m =</span>
<span class="sd">        \begin{cases}</span>
<span class="sd">            \sqrt{2} * \Re(Y_l^m)  \; if m &gt; 0 \\</span>
<span class="sd">            Y^0_l \; if m = 0 \\</span>
<span class="sd">            \sqrt{2} * \Im(Y_l^{|m|}) \; if m &lt; 0 \\</span>
<span class="sd">        \end{cases}</span>

<span class="sd">    This may take scalar or array arguments. The inputs will be broadcast</span>
<span class="sd">    against each other.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sh_order_max : int</span>
<span class="sd">        The maximum order ($l$) of the spherical harmonic basis.</span>
<span class="sd">    theta : float [0, pi]</span>
<span class="sd">        The polar (colatitudinal) coordinate.</span>
<span class="sd">    phi : float [0, 2*pi]</span>
<span class="sd">        The azimuthal (longitudinal) coordinate.</span>
<span class="sd">    full_basis: bool, optional</span>
<span class="sd">        If true, returns a basis including odd order SH functions as well as</span>
<span class="sd">        even order SH functions. Else returns only even order SH functions.</span>
<span class="sd">    legacy: bool, optional</span>
<span class="sd">        If true, uses MRtrix 0.2 SH basis definition, where the ``sqrt(2)``</span>
<span class="sd">        factor is omitted. Else, uses MRtrix 3 definition presented above.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    real_sh : real float</span>
<span class="sd">        The real harmonic $Y_l^m$ sampled at ``theta`` and ``phi``.</span>
<span class="sd">    m_values : array of int</span>
<span class="sd">        The phase factor ($m$) of the harmonics.</span>
<span class="sd">    l_values : array of int</span>
<span class="sd">        The order ($l$) of the harmonics.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span> <span class="o">=</span> <span class="n">sph_harm_ind_list</span><span class="p">(</span><span class="n">sh_order_max</span><span class="p">,</span> <span class="n">full_basis</span><span class="o">=</span><span class="n">full_basis</span><span class="p">)</span>

    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">real_sh</span> <span class="o">=</span> <span class="n">real_sh_tournier_from_index</span><span class="p">(</span><span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="n">legacy</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">real_sh</span><span class="p">,</span> <span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span></div>



<div class="viewcode-block" id="real_sh_descoteaux">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.real_sh_descoteaux">[docs]</a>
<span class="nd">@deprecated_params</span><span class="p">(</span><span class="s2">&quot;sh_order&quot;</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s2">&quot;sh_order_max&quot;</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.9&quot;</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">)</span>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">real_sh_descoteaux</span><span class="p">(</span><span class="n">sh_order_max</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">full_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute real spherical harmonics.</span>

<span class="sd">    The definition adopted here follows :footcite:p:`Descoteaux2007`, where the</span>
<span class="sd">    real harmonic $Y_l^m$ is defined to be:</span>

<span class="sd">    .. math::</span>
<span class="sd">       :nowrap:</span>

<span class="sd">        Y_l^m =</span>
<span class="sd">        \begin{cases}</span>
<span class="sd">            \sqrt{2} * \Im(Y_l^m) \; if m &gt; 0 \\</span>
<span class="sd">            Y^0_l \; if m = 0 \\</span>
<span class="sd">            \sqrt{2} * \Re(Y_l^m)  \; if m &lt; 0 \\</span>
<span class="sd">        \end{cases}</span>

<span class="sd">    This may take scalar or array arguments. The inputs will be broadcast</span>
<span class="sd">    against each other.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sh_order_max : int</span>
<span class="sd">        The maximum order ($l$) of the spherical harmonic basis.</span>
<span class="sd">    theta : float [0, pi]</span>
<span class="sd">        The polar (colatitudinal) coordinate.</span>
<span class="sd">    phi : float [0, 2*pi]</span>
<span class="sd">        The azimuthal (longitudinal) coordinate.</span>
<span class="sd">    full_basis: bool, optional</span>
<span class="sd">        If true, returns a basis including odd order SH functions as well as</span>
<span class="sd">        even order SH functions. Otherwise returns only even order SH</span>
<span class="sd">        functions.</span>
<span class="sd">    legacy: bool, optional</span>
<span class="sd">        If true, uses DIPY&#39;s legacy descoteaux07 implementation (where $|m|$</span>
<span class="sd">        for m &lt; 0). Else, implements the basis as defined in Descoteaux et al.</span>
<span class="sd">        2007.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    real_sh : real float</span>
<span class="sd">        The real harmonic $Y_l^m$ sampled at ``theta`` and ``phi``.</span>
<span class="sd">    m_values : array of int</span>
<span class="sd">        The phase factor ($m$) of the harmonics.</span>
<span class="sd">    l_values : array of int</span>
<span class="sd">        The order ($l$) of the harmonics.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m_value</span><span class="p">,</span> <span class="n">l_value</span> <span class="o">=</span> <span class="n">sph_harm_ind_list</span><span class="p">(</span><span class="n">sh_order_max</span><span class="p">,</span> <span class="n">full_basis</span><span class="o">=</span><span class="n">full_basis</span><span class="p">)</span>

    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">real_sh</span> <span class="o">=</span> <span class="n">real_sh_descoteaux_from_index</span><span class="p">(</span><span class="n">m_value</span><span class="p">,</span> <span class="n">l_value</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="n">legacy</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">real_sh</span><span class="p">,</span> <span class="n">m_value</span><span class="p">,</span> <span class="n">l_value</span></div>



<div class="viewcode-block" id="real_sym_sh_mrtrix">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.real_sym_sh_mrtrix">[docs]</a>
<span class="nd">@deprecate_with_version</span><span class="p">(</span>
    <span class="s2">&quot;dipy.reconst.shm.real_sym_sh_mrtrix is deprecated, &quot;</span>
    <span class="s2">&quot;Please use dipy.reconst.shm.real_sh_tournier instead&quot;</span><span class="p">,</span>
    <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.3&quot;</span><span class="p">,</span>
    <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@deprecated_params</span><span class="p">(</span><span class="s2">&quot;sh_order&quot;</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s2">&quot;sh_order_max&quot;</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.9&quot;</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">real_sym_sh_mrtrix</span><span class="p">(</span><span class="n">sh_order_max</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute real symmetric spherical harmonics.</span>

<span class="sd">    The SH are computed as initially defined in :footcite:t:`Tournier2007`,</span>
<span class="sd">    where the real harmonic $Y_l^m$ is defined to be:</span>

<span class="sd">    .. math::</span>
<span class="sd">       :nowrap:</span>

<span class="sd">        Y_l^m =</span>
<span class="sd">        \begin{cases}</span>
<span class="sd">            \Re(Y_l^m) \; if m &gt; 0 \\</span>
<span class="sd">            Y^0_l \; if m = 0 \\</span>
<span class="sd">            \Im(Y_l^{|m|}) \; if m &lt; 0 \\</span>
<span class="sd">        \end{cases}</span>

<span class="sd">    This may take scalar or array arguments. The inputs will be broadcast</span>
<span class="sd">    against each other.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sh_order_max : int</span>
<span class="sd">        The maximum order ($l$) of the spherical harmonic basis.</span>
<span class="sd">    theta : float [0, pi]</span>
<span class="sd">        The polar (colatitudinal) coordinate.</span>
<span class="sd">    phi : float [0, 2*pi]</span>
<span class="sd">        The azimuthal (longitudinal) coordinate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    y_mn : real float</span>
<span class="sd">        The real harmonic $Y_l^m$ sampled at ``theta`` and ``phi`` as</span>
<span class="sd">        implemented in mrtrix. Warning: the basis is :footcite:t:`Tournier2007`;</span>
<span class="sd">        :footcite:p:`Tournier2004` is slightly different.</span>
<span class="sd">    m_values : array</span>
<span class="sd">        The phase factor ($m$) of the harmonics.</span>
<span class="sd">    l_values : array</span>
<span class="sd">        The order ($l$) of the harmonics.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">real_sh_tournier</span><span class="p">(</span><span class="n">sh_order_max</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="real_sym_sh_basis">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.real_sym_sh_basis">[docs]</a>
<span class="nd">@deprecate_with_version</span><span class="p">(</span>
    <span class="s2">&quot;dipy.reconst.shm.real_sym_sh_basis is deprecated, &quot;</span>
    <span class="s2">&quot;Please use dipy.reconst.shm.real_sh_descoteaux &quot;</span>
    <span class="s2">&quot;instead&quot;</span><span class="p">,</span>
    <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.3&quot;</span><span class="p">,</span>
    <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@deprecated_params</span><span class="p">(</span><span class="s2">&quot;sh_order&quot;</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s2">&quot;sh_order_max&quot;</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.9&quot;</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">real_sym_sh_basis</span><span class="p">(</span><span class="n">sh_order_max</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Samples a real symmetric spherical harmonic basis at point on the sphere</span>

<span class="sd">    Samples the basis functions up to order `sh_order_max` at points on the</span>
<span class="sd">    sphere given by `theta` and `phi`. The basis functions are defined here the</span>
<span class="sd">    same way as in :footcite:p:`Descoteaux2007` where the real harmonic $Y_l^m$</span>
<span class="sd">    is defined to be:</span>

<span class="sd">    .. math::</span>
<span class="sd">       :nowrap:</span>

<span class="sd">        Y_l^m =</span>
<span class="sd">        \begin{cases}</span>
<span class="sd">            \sqrt{2} * \Im(Y_l^m) \; if m &gt; 0 \\</span>
<span class="sd">            Y^0_l \; if m = 0 \\</span>
<span class="sd">            \sqrt{2} * \Im(Y_l^{|m|}) \; if m &lt; 0 \\</span>
<span class="sd">        \end{cases}</span>

<span class="sd">    This may take scalar or array arguments. The inputs will be broadcast</span>
<span class="sd">    against each other.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sh_order_max : int</span>
<span class="sd">        The maximum order ($l$) of the spherical harmonic basis. Even int &gt; 0,</span>
<span class="sd">        max spherical harmonic order</span>
<span class="sd">    theta : float [0, 2*pi]</span>
<span class="sd">        The azimuthal (longitudinal) coordinate.</span>
<span class="sd">    phi : float [0, pi]</span>
<span class="sd">        The polar (colatitudinal) coordinate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    y_mn : real float</span>
<span class="sd">        The real harmonic $Y_l^m$ sampled at ``theta`` and ``phi``</span>
<span class="sd">    m_values : array of int</span>
<span class="sd">        The phase factor ($m$) of the harmonics.</span>
<span class="sd">    l_values : array of int</span>
<span class="sd">        The order ($l$) of the harmonics.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">real_sh_descoteaux</span><span class="p">(</span><span class="n">sh_order_max</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<span class="n">sph_harm_lookup</span> <span class="o">=</span> <span class="p">{</span>
    <span class="kc">None</span><span class="p">:</span> <span class="n">real_sh_descoteaux</span><span class="p">,</span>
    <span class="s2">&quot;tournier07&quot;</span><span class="p">:</span> <span class="n">real_sh_tournier</span><span class="p">,</span>
    <span class="s2">&quot;descoteaux07&quot;</span><span class="p">:</span> <span class="n">real_sh_descoteaux</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="sph_harm_ind_list">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.sph_harm_ind_list">[docs]</a>
<span class="nd">@deprecated_params</span><span class="p">(</span><span class="s2">&quot;sh_order&quot;</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s2">&quot;sh_order_max&quot;</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.9&quot;</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">)</span>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">sph_harm_ind_list</span><span class="p">(</span><span class="n">sh_order_max</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">full_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the order (``l``) and phase_factor (``m``) of all the symmetric</span>
<span class="sd">    spherical harmonics of order less then or equal to ``sh_order_max``.</span>
<span class="sd">    The results, ``m_list`` and ``l_list`` are kx1 arrays, where k depends on</span>
<span class="sd">    ``sh_order_max``.</span>
<span class="sd">    They can be passed to :func:`real_sh_descoteaux_from_index` and</span>
<span class="sd">    :func:``real_sh_tournier_from_index``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sh_order_max : int</span>
<span class="sd">        The maximum order ($l$) of the spherical harmonic basis.</span>
<span class="sd">        Even int &gt; 0, max order to return</span>
<span class="sd">    full_basis: bool, optional</span>
<span class="sd">        True for SH basis with even and odd order terms</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    m_list : array of int</span>
<span class="sd">        phase factors ($m$) of even spherical harmonics</span>
<span class="sd">    l_list : array of int</span>
<span class="sd">        orders ($l$) of even spherical harmonics</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    shm.real_sh_descoteaux_from_index, shm.real_sh_tournier_from_index</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">full_basis</span><span class="p">:</span>
        <span class="n">l_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sh_order_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ncoef</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">sh_order_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">sh_order_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sh_order_max</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;sh_order_max must be an even integer &gt;= 0&quot;</span><span class="p">)</span>
        <span class="n">l_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sh_order_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ncoef</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">sh_order_max</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">sh_order_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">l_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">l_range</span><span class="p">,</span> <span class="n">l_range</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">m_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ncoef</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">l_range</span><span class="p">:</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># makes the arrays ncoef by 1, allows for easy broadcasting later in code</span>
    <span class="k">return</span> <span class="n">m_list</span><span class="p">,</span> <span class="n">l_list</span></div>



<div class="viewcode-block" id="order_from_ncoef">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.order_from_ncoef">[docs]</a>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">order_from_ncoef</span><span class="p">(</span><span class="n">ncoef</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">full_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a number ``n`` of coefficients, calculate back the ``sh_order_max``</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ncoef: int</span>
<span class="sd">        number of coefficients</span>
<span class="sd">    full_basis: bool, optional</span>
<span class="sd">        True when coefficients are for a full SH basis.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sh_order_max: int</span>
<span class="sd">        maximum order ($l$) of SH basis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">full_basis</span><span class="p">:</span>
        <span class="c1"># Solve the equation :</span>
        <span class="c1"># ncoef = (sh_order_max + 1) * (sh_order_max + 1)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ncoef</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Solve the quadratic equation derived from :</span>
    <span class="c1"># ncoef = (sh_order_max + 2) * (sh_order_max + 1) / 2</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">9</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ncoef</span><span class="p">))</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span></div>



<div class="viewcode-block" id="smooth_pinv">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.smooth_pinv">[docs]</a>
<span class="k">def</span> <span class="nf">smooth_pinv</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Regularized pseudo-inverse</span>

<span class="sd">    Computes a regularized least square inverse of B</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    B : array_like (n, m)</span>
<span class="sd">        Matrix to be inverted</span>
<span class="sd">    L : array_like (m,)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    inv : ndarray (m, n)</span>
<span class="sd">        regularized least square inverse of B</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    In the literature this inverse is often written $(B^{T}B+L^{2})^{-1}B^{T}$.</span>
<span class="sd">    However here this inverse is implemented using the pseudo-inverse because</span>
<span class="sd">    it is more numerically stable than the direct implementation of the matrix</span>
<span class="sd">    product.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
    <span class="n">inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">L</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">inv</span><span class="p">[:,</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)]</span></div>



<div class="viewcode-block" id="lazy_index">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.lazy_index">[docs]</a>
<span class="k">def</span> <span class="nf">lazy_index</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Produces a lazy index</span>

<span class="sd">    Returns a slice that can be used for indexing an array, if no slice can be</span>
<span class="sd">    made index is returned as is.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">index</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">slice</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">index</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">slice</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>



<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">_gfa_sh</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">sh0_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The gfa of the odf, computed from the spherical harmonic coefficients</span>

<span class="sd">    This is a private function because it only works for coefficients of</span>
<span class="sd">    normalized sh bases.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coef : array</span>
<span class="sd">        The coefficients, using a normalized sh basis, that represent each odf.</span>
<span class="sd">    sh0_index : int, optional</span>
<span class="sd">        The index of the coefficient associated with the 0th order sh harmonic.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    gfa_values : array</span>
<span class="sd">        The gfa of each odf.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coef_sq</span> <span class="o">=</span> <span class="n">coef</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">numer</span> <span class="o">=</span> <span class="n">coef_sq</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">sh0_index</span><span class="p">]</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="n">coef_sq</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># The sum of the square of the coefficients being zero is the same as all</span>
    <span class="c1"># the coefficients being zero</span>
    <span class="n">allzero</span> <span class="o">=</span> <span class="n">denom</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="c1"># By adding 1 to numer and denom where both and are 0, we prevent 0/0</span>
    <span class="n">numer</span> <span class="o">=</span> <span class="n">numer</span> <span class="o">+</span> <span class="n">allzero</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="n">denom</span> <span class="o">+</span> <span class="n">allzero</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">numer</span> <span class="o">/</span> <span class="n">denom</span><span class="p">))</span>


<div class="viewcode-block" id="SphHarmModel">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.SphHarmModel">[docs]</a>
<span class="k">class</span> <span class="nc">SphHarmModel</span><span class="p">(</span><span class="n">OdfModel</span><span class="p">,</span> <span class="n">Cache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;To be subclassed by all models that return a SphHarmFit when fit.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SphHarmModel.sampling_matrix">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.SphHarmModel.sampling_matrix">[docs]</a>
    <span class="k">def</span> <span class="nf">sampling_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sphere</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The matrix needed to sample ODFs from coefficients of the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sphere : Sphere</span>
<span class="sd">            Points used to sample ODF.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sampling_matrix : array</span>
<span class="sd">            The size of the matrix will be (N, M) where N is the number of</span>
<span class="sd">            vertices on sphere and M is the number of coefficients needed by</span>
<span class="sd">            the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sampling_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_get</span><span class="p">(</span><span class="s2">&quot;sampling_matrix&quot;</span><span class="p">,</span> <span class="n">sphere</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sampling_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sh_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sh_order_max</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">sphere</span><span class="o">.</span><span class="n">theta</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="n">sphere</span><span class="o">.</span><span class="n">phi</span>
            <span class="n">sampling_matrix</span><span class="p">,</span> <span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span> <span class="o">=</span> <span class="n">real_sh_descoteaux</span><span class="p">(</span>
                <span class="n">sh_order</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_set</span><span class="p">(</span><span class="s2">&quot;sampling_matrix&quot;</span><span class="p">,</span> <span class="n">sphere</span><span class="p">,</span> <span class="n">sampling_matrix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sampling_matrix</span></div>
</div>



<div class="viewcode-block" id="QballBaseModel">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.QballBaseModel">[docs]</a>
<span class="k">class</span> <span class="nc">QballBaseModel</span><span class="p">(</span><span class="n">SphHarmModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;To be subclassed by Qball type models.&quot;&quot;&quot;</span>

    <span class="nd">@deprecated_params</span><span class="p">(</span><span class="s2">&quot;sh_order&quot;</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s2">&quot;sh_order_max&quot;</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.9&quot;</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">)</span>
    <span class="nd">@warning_for_keywords</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">gtab</span><span class="p">,</span> <span class="n">sh_order_max</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="mf">0.006</span><span class="p">,</span> <span class="n">min_signal</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">assume_normed</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a model that can be used to fit or sample diffusion data</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        gtab : GradientTable</span>
<span class="sd">            Diffusion gradients used to acquire data</span>
<span class="sd">        sh_order_max : even int &gt;= 0</span>
<span class="sd">            the maximal spherical harmonic order ($l$) of the model</span>
<span class="sd">        smooth : float between 0 and 1, optional</span>
<span class="sd">            The regularization parameter of the model</span>
<span class="sd">        min_signal : float, &gt; 0, optional</span>
<span class="sd">            During fitting, all signal values less than `min_signal` are</span>
<span class="sd">            clipped to `min_signal`. This is done primarily to avoid values</span>
<span class="sd">            less than or equal to zero when taking logs.</span>
<span class="sd">        assume_normed : bool, optional</span>
<span class="sd">            If True, clipping and normalization of the data with respect to the</span>
<span class="sd">            mean B0 signal are skipped during mode fitting. This is an advanced</span>
<span class="sd">            feature and should be used with care.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        normalize_data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">SphHarmModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gtab</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_where_b0s</span> <span class="o">=</span> <span class="n">lazy_index</span><span class="p">(</span><span class="n">gtab</span><span class="o">.</span><span class="n">b0s_mask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_where_dwi</span> <span class="o">=</span> <span class="n">lazy_index</span><span class="p">(</span><span class="o">~</span><span class="n">gtab</span><span class="o">.</span><span class="n">b0s_mask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assume_normed</span> <span class="o">=</span> <span class="n">assume_normed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_signal</span> <span class="o">=</span> <span class="n">min_signal</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">gtab</span><span class="o">.</span><span class="n">gradients</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_where_dwi</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span> <span class="o">=</span> <span class="n">cart2sphere</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">B</span><span class="p">,</span> <span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span> <span class="o">=</span> <span class="n">real_sh_descoteaux</span><span class="p">(</span>
            <span class="n">sh_order_max</span><span class="p">,</span> <span class="n">theta</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">phi</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="o">-</span><span class="n">l_values</span> <span class="o">*</span> <span class="p">(</span><span class="n">l_values</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">legendre0</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">lpn</span><span class="p">(</span><span class="n">sh_order_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">legendre0</span><span class="p">[</span><span class="n">l_values</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sh_order_max</span> <span class="o">=</span> <span class="n">sh_order_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">B</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_values</span> <span class="o">=</span> <span class="n">m_values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_values</span> <span class="o">=</span> <span class="n">l_values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_fit_matrix</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">smooth</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_fit_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Should be set in a subclass and is called by __init__&quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;User must implement this method in a subclass&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<div class="viewcode-block" id="QballBaseModel.fit">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.QballBaseModel.fit">[docs]</a>
    <span class="nd">@warning_for_keywords</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fits the model to diffusion data and returns the model fit&quot;&quot;&quot;</span>
        <span class="c1"># Normalize the data and fit coefficients</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">assume_normed</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">normalize_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where_b0s</span><span class="p">,</span> <span class="n">min_signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_signal</span><span class="p">)</span>

        <span class="c1"># Compute coefficients using abstract method</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_shm_coef</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Apply the mask to the coefficients</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">coef</span> <span class="o">*=</span> <span class="n">mask</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">SphHarmFit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SphHarmFit">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.SphHarmFit">[docs]</a>
<span class="k">class</span> <span class="nc">SphHarmFit</span><span class="p">(</span><span class="n">OdfFit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Diffusion data fit to a spherical harmonic model&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">shm_coef</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shm_coef</span> <span class="o">=</span> <span class="n">shm_coef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shm_coef</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Allowing indexing into fit&quot;&quot;&quot;</span>
        <span class="c1"># Index shm_coefficients</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">coef_index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="p">(</span><span class="bp">Ellipsis</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coef_index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="n">new_coef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shm_coef</span><span class="p">[</span><span class="n">coef_index</span><span class="p">]</span>

        <span class="c1"># Index mask</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">new_mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">new_coef</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_mask</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">SphHarmFit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">new_coef</span><span class="p">,</span> <span class="n">new_mask</span><span class="p">)</span>

<div class="viewcode-block" id="SphHarmFit.odf">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.SphHarmFit.odf">[docs]</a>
    <span class="k">def</span> <span class="nf">odf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sphere</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Samples the odf function on the points of a sphere</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sphere : Sphere</span>
<span class="sd">            The points on which to sample the odf.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        values : ndarray</span>
<span class="sd">            The value of the odf on each point of `sphere`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sampling_matrix</span><span class="p">(</span><span class="n">sphere</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shm_coeff</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></div>


<div class="viewcode-block" id="SphHarmFit.gfa">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.SphHarmFit.gfa">[docs]</a>
    <span class="nd">@auto_attr</span>
    <span class="k">def</span> <span class="nf">gfa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_gfa_sh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shm_coeff</span><span class="p">,</span> <span class="n">sh0_index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shm_coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The spherical harmonic coefficients of the odf</span>

<span class="sd">        Make this a property for now, if there is a use case for modifying</span>
<span class="sd">        the coefficients we can add a setter or expose the coefficients more</span>
<span class="sd">        directly</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shm_coef</span>

<div class="viewcode-block" id="SphHarmFit.predict">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.SphHarmFit.predict">[docs]</a>
    <span class="nd">@warning_for_keywords</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">gtab</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">S0</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predict the diffusion signal from the model coefficients.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        gtab : a GradientTable class instance</span>
<span class="sd">            The directions and bvalues on which prediction is desired</span>

<span class="sd">        S0 : float array</span>
<span class="sd">           The mean non-diffusion-weighted signal in each voxel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;predict&quot;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;This model does not have prediction implemented yet&quot;</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shm_coef</span><span class="p">,</span> <span class="n">gtab</span><span class="o">=</span><span class="n">gtab</span><span class="p">,</span> <span class="n">S0</span><span class="o">=</span><span class="n">S0</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CsaOdfModel">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.CsaOdfModel">[docs]</a>
<span class="k">class</span> <span class="nc">CsaOdfModel</span><span class="p">(</span><span class="n">QballBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implementation of Constant Solid Angle reconstruction method.</span>

<span class="sd">    See :footcite:p:`Aganj2009` for further details about the method.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">min</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="nb">max</span> <span class="o">=</span> <span class="mf">0.999</span>
    <span class="n">_n0_const</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_fit_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">smooth</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The fit matrix, is used by fit_coefficients to return the</span>
<span class="sd">        coefficients of the odf&quot;&quot;&quot;</span>
        <span class="n">invB</span> <span class="o">=</span> <span class="n">smooth_pinv</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">smooth</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">L</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_matrix</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span> <span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">invB</span>

    <span class="nd">@warning_for_keywords</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_get_shm_coef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the coefficients of the model&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where_dwi</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
        <span class="n">loglog_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">sh_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">loglog_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">sh_coef</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n0_const</span>
        <span class="k">return</span> <span class="n">sh_coef</span></div>



<div class="viewcode-block" id="OpdtModel">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.OpdtModel">[docs]</a>
<span class="k">class</span> <span class="nc">OpdtModel</span><span class="p">(</span><span class="n">QballBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implementation of Orientation Probability Density Transform</span>
<span class="sd">    reconstruction method.</span>

<span class="sd">    See :footcite:p:`TristanVega2009a` and :footcite:p:`TristanVega2010` for</span>
<span class="sd">    further details about the method.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_set_fit_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">smooth</span><span class="p">):</span>
        <span class="n">invB</span> <span class="o">=</span> <span class="n">smooth_pinv</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">smooth</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">L</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">delta_b</span> <span class="o">=</span> <span class="n">F</span> <span class="o">*</span> <span class="n">L</span> <span class="o">*</span> <span class="n">invB</span>
        <span class="n">delta_q</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">F</span> <span class="o">*</span> <span class="n">invB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_matrix</span> <span class="o">=</span> <span class="n">delta_b</span><span class="p">,</span> <span class="n">delta_q</span>

    <span class="nd">@warning_for_keywords</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_get_shm_coef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the coefficients of the model&quot;&quot;&quot;</span>
        <span class="n">delta_b</span><span class="p">,</span> <span class="n">delta_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_matrix</span>
        <span class="k">return</span> <span class="n">_slowadc_formula</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where_dwi</span><span class="p">],</span> <span class="n">delta_b</span><span class="p">,</span> <span class="n">delta_q</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_slowadc_formula</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">delta_b</span><span class="p">,</span> <span class="n">delta_q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;formula used in SlowAdcOpdfModel&quot;&quot;&quot;</span>
    <span class="n">logd</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">logd</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.5</span> <span class="o">-</span> <span class="n">logd</span><span class="p">)</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">delta_q</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">delta_b</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>


<div class="viewcode-block" id="QballModel">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.QballModel">[docs]</a>
<span class="k">class</span> <span class="nc">QballModel</span><span class="p">(</span><span class="n">QballBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implementation of regularized Qball reconstruction method.</span>

<span class="sd">    See :footcite:p:`Descoteaux2007` for further details about the method.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_set_fit_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">smooth</span><span class="p">):</span>
        <span class="n">invB</span> <span class="o">=</span> <span class="n">smooth_pinv</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">smooth</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_matrix</span> <span class="o">=</span> <span class="n">F</span> <span class="o">*</span> <span class="n">invB</span>

    <span class="nd">@warning_for_keywords</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_get_shm_coef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the coefficients of the model&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where_dwi</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></div>



<div class="viewcode-block" id="normalize_data">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.normalize_data">[docs]</a>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">normalize_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">where_b0</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">min_signal</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Normalizes the data with respect to the mean b0&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;out must be floating point&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">data</span>

    <span class="n">out</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">min_signal</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">where_b0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">/=</span> <span class="n">b0</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="hat">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.hat">[docs]</a>
<span class="k">def</span> <span class="nf">hat</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the hat matrix for the design matrix B&quot;&quot;&quot;</span>

    <span class="n">U</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">H</span></div>



<div class="viewcode-block" id="lcr_matrix">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.lcr_matrix">[docs]</a>
<span class="k">def</span> <span class="nf">lcr_matrix</span><span class="p">(</span><span class="n">H</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a matrix for computing leveraged, centered residuals from data</span>

<span class="sd">    if r = (d-Hd), the leveraged centered residuals are lcr = (r/l)-mean(r/l)</span>
<span class="sd">    returns the matrix R, such that lcr = Rd</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">H</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;H should be a square matrix&quot;</span><span class="p">)</span>

    <span class="n">leverages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">H</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(),</span> <span class="n">where</span><span class="o">=</span><span class="n">H</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">leverages</span> <span class="o">=</span> <span class="n">leverages</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">R</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">))</span> <span class="o">-</span> <span class="n">H</span><span class="p">)</span> <span class="o">/</span> <span class="n">leverages</span>
    <span class="k">return</span> <span class="n">R</span> <span class="o">-</span> <span class="n">R</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>



<div class="viewcode-block" id="bootstrap_data_array">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.bootstrap_data_array">[docs]</a>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">bootstrap_data_array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">permute</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Applies the Residual Bootstraps to the data given H and R</span>

<span class="sd">    data must be normalized, ie 0 &lt; data &lt;= 1</span>

<span class="sd">    This function, and the bootstrap_data_voxel function, calculate</span>
<span class="sd">    residual-bootstrap samples given a Hat matrix and a Residual matrix. These</span>
<span class="sd">    samples can be used for non-parametric statistics or for bootstrap</span>
<span class="sd">    probabilistic tractography,</span>

<span class="sd">    See :footcite:p:`Berman2008`, :footcite:p:`Haroon2009`, and</span>
<span class="sd">    :footcite:p:`Jeurissen2011`.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">permute</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">permute</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">H</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">permute</span><span class="p">)</span> <span class="o">==</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="n">permute</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">H</span> <span class="o">+</span> <span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>



<div class="viewcode-block" id="bootstrap_data_voxel">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.bootstrap_data_voxel">[docs]</a>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">bootstrap_data_voxel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">permute</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Like bootstrap_data_array but faster when for a single voxel</span>

<span class="sd">    data must be 1d and normalized</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">permute</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">permute</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">boot_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">boot_data</span> <span class="o">+=</span> <span class="n">r</span><span class="p">[</span><span class="n">permute</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">boot_data</span></div>



<div class="viewcode-block" id="ResidualBootstrapWrapper">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.ResidualBootstrapWrapper">[docs]</a>
<span class="k">class</span> <span class="nc">ResidualBootstrapWrapper</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a residual bootstrap sample of the signal_object when indexed</span>

<span class="sd">    Wraps a signal_object, this signal object can be an interpolator. When</span>
<span class="sd">    indexed, the wrapper indexes the signal_object to get the signal.</span>
<span class="sd">    There wrapper than samples the residual bootstrap distribution of signal and</span>
<span class="sd">    returns that sample.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@warning_for_keywords</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_object</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">where_dwi</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">min_signal</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Builds a ResidualBootstrapWapper</span>

<span class="sd">        Given some linear model described by B, the design matrix, and a</span>
<span class="sd">        signal_object, returns an object which can sample the residual</span>
<span class="sd">        bootstrap distribution of the signal. We assume that the signals are</span>
<span class="sd">        normalized so we clip the bootstrap samples to be between `min_signal`</span>
<span class="sd">        and 1.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        signal_object : some object that can be indexed</span>
<span class="sd">            This object should return diffusion weighted signals when indexed.</span>
<span class="sd">        B : ndarray, ndim=2</span>
<span class="sd">            The design matrix of the spherical harmonics model used to fit the</span>
<span class="sd">            data. This is the model that will be used to compute the residuals</span>
<span class="sd">            and sample the residual bootstrap distribution</span>
<span class="sd">        where_dwi :</span>
<span class="sd">            indexing object to find diffusion weighted signals from signal</span>
<span class="sd">        min_signal : float</span>
<span class="sd">            The lowest allowable signal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal_object</span> <span class="o">=</span> <span class="n">signal_object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_H</span> <span class="o">=</span> <span class="n">hat</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_R</span> <span class="o">=</span> <span class="n">lcr_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_H</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min_signal</span> <span class="o">=</span> <span class="n">min_signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_where_dwi</span> <span class="o">=</span> <span class="n">where_dwi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">signal_object</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voxel_size</span> <span class="o">=</span> <span class="n">signal_object</span><span class="o">.</span><span class="n">voxel_size</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Indexes self._signal_object and bootstraps the result&quot;&quot;&quot;</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal_object</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dwi_signal</span> <span class="o">=</span> <span class="n">signal</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_where_dwi</span><span class="p">]</span>
        <span class="n">boot_signal</span> <span class="o">=</span> <span class="n">bootstrap_data_voxel</span><span class="p">(</span><span class="n">dwi_signal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_R</span><span class="p">)</span>
        <span class="n">boot_signal</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_signal</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">boot_signal</span><span class="p">)</span>
        <span class="n">signal</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_where_dwi</span><span class="p">]</span> <span class="o">=</span> <span class="n">boot_signal</span>
        <span class="k">return</span> <span class="n">signal</span></div>



<div class="viewcode-block" id="sf_to_sh">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.sf_to_sh">[docs]</a>
<span class="nd">@deprecated_params</span><span class="p">(</span><span class="s2">&quot;sh_order&quot;</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s2">&quot;sh_order_max&quot;</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.9&quot;</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">)</span>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">sf_to_sh</span><span class="p">(</span>
    <span class="n">sf</span><span class="p">,</span>
    <span class="n">sphere</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">sh_order_max</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">basis_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">full_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">legacy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">smooth</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Spherical function to spherical harmonics (SH).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sf : ndarray</span>
<span class="sd">        Values of a function on the given ``sphere``.</span>
<span class="sd">    sphere : Sphere</span>
<span class="sd">        The points on which the sf is defined.</span>
<span class="sd">    sh_order_max : int, optional</span>
<span class="sd">        Maximum SH order (l) in the SH fit.  For ``sh_order_max``, there will be</span>
<span class="sd">        ``(sh_order_max + 1) * (sh_order_max + 2) / 2`` SH coefficients for a</span>
<span class="sd">        symmetric basis and ``(sh_order_max + 1) * (sh_order_max + 1)``</span>
<span class="sd">        coefficients for a full SH basis.</span>
<span class="sd">    basis_type : {None, &#39;tournier07&#39;, &#39;descoteaux07&#39;}, optional</span>
<span class="sd">        ``None`` for the default DIPY basis,</span>
<span class="sd">        ``tournier07`` for the Tournier 2007 :footcite:p:`Tournier2007`,</span>
<span class="sd">        :footcite:p:`Tournier2019` basis,</span>
<span class="sd">        ``descoteaux07`` for the Descoteaux 2007 :footcite:p:`Descoteaux2007`</span>
<span class="sd">        basis,</span>
<span class="sd">        (``None`` defaults to ``descoteaux07``).</span>
<span class="sd">    full_basis: bool, optional</span>
<span class="sd">        True for using a SH basis containing even and odd order SH functions.</span>
<span class="sd">        False for using a SH basis consisting only of even order SH functions.</span>
<span class="sd">    legacy: bool, optional</span>
<span class="sd">        True to use a legacy basis definition for backward compatibility</span>
<span class="sd">        with previous ``tournier07`` and ``descoteaux07`` implementations.</span>
<span class="sd">    smooth : float, optional</span>
<span class="sd">        Lambda-regularization in the SH fit.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sh : ndarray</span>
<span class="sd">        SH coefficients representing the input function.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sph_harm_basis</span> <span class="o">=</span> <span class="n">sph_harm_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">basis_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sph_harm_basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid basis name.&quot;</span><span class="p">)</span>
    <span class="n">B</span><span class="p">,</span> <span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span> <span class="o">=</span> <span class="n">sph_harm_basis</span><span class="p">(</span>
        <span class="n">sh_order_max</span><span class="p">,</span> <span class="n">sphere</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">sphere</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="n">full_basis</span><span class="o">=</span><span class="n">full_basis</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="n">legacy</span>
    <span class="p">)</span>

    <span class="n">L</span> <span class="o">=</span> <span class="o">-</span><span class="n">l_values</span> <span class="o">*</span> <span class="p">(</span><span class="n">l_values</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">invB</span> <span class="o">=</span> <span class="n">smooth_pinv</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">smooth</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span><span class="p">)</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="n">invB</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sh</span></div>



<div class="viewcode-block" id="sh_to_sf">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.sh_to_sf">[docs]</a>
<span class="nd">@deprecated_params</span><span class="p">(</span><span class="s2">&quot;sh_order&quot;</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s2">&quot;sh_order_max&quot;</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.9&quot;</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">)</span>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">sh_to_sf</span><span class="p">(</span>
    <span class="n">sh</span><span class="p">,</span> <span class="n">sphere</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">sh_order_max</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">basis_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">full_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Spherical harmonics (SH) to spherical function (SF).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sh : ndarray</span>
<span class="sd">        SH coefficients representing a spherical function.</span>
<span class="sd">    sphere : Sphere</span>
<span class="sd">        The points on which to sample the spherical function.</span>
<span class="sd">    sh_order_max : int, optional</span>
<span class="sd">        Maximum SH order (l) in the SH fit.  For ``sh_order_max``, there will be</span>
<span class="sd">        ``(sh_order_max + 1) * (sh_order_max + 2) / 2`` SH coefficients for a</span>
<span class="sd">        symmetric basis and ``(sh_order_max + 1) * (sh_order_max + 1)``</span>
<span class="sd">        coefficients for a full SH basis.</span>
<span class="sd">    basis_type : {None, &#39;tournier07&#39;, &#39;descoteaux07&#39;}, optional</span>
<span class="sd">        ``None`` for the default DIPY basis,</span>
<span class="sd">        ``tournier07`` for the Tournier 2007 :footcite:p:`Tournier2007`,</span>
<span class="sd">        :footcite:p:`Tournier2019` basis,</span>
<span class="sd">        ``descoteaux07`` for the Descoteaux 2007 :footcite:p:`Descoteaux2007`</span>
<span class="sd">        basis,</span>
<span class="sd">        (``None`` defaults to ``descoteaux07``).</span>
<span class="sd">    full_basis: bool, optional</span>
<span class="sd">        True to use a SH basis containing even and odd order SH functions.</span>
<span class="sd">        Else, use a SH basis consisting only of even order SH functions.</span>
<span class="sd">    legacy: bool, optional</span>
<span class="sd">        True to use a legacy basis definition for backward compatibility</span>
<span class="sd">        with previous ``tournier07`` and ``descoteaux07`` implementations.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sf : ndarray</span>
<span class="sd">         Spherical function values on the ``sphere``.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sph_harm_basis</span> <span class="o">=</span> <span class="n">sph_harm_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">basis_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sph_harm_basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid basis name.&quot;</span><span class="p">)</span>
    <span class="n">B</span><span class="p">,</span> <span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span> <span class="o">=</span> <span class="n">sph_harm_basis</span><span class="p">(</span>
        <span class="n">sh_order_max</span><span class="p">,</span> <span class="n">sphere</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">sphere</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="n">full_basis</span><span class="o">=</span><span class="n">full_basis</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="n">legacy</span>
    <span class="p">)</span>

    <span class="n">sf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sf</span></div>



<div class="viewcode-block" id="sh_to_sf_matrix">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.sh_to_sf_matrix">[docs]</a>
<span class="nd">@deprecated_params</span><span class="p">(</span><span class="s2">&quot;sh_order&quot;</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s2">&quot;sh_order_max&quot;</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.9&quot;</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">)</span>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">sh_to_sf_matrix</span><span class="p">(</span>
    <span class="n">sphere</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">sh_order_max</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">basis_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">full_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">legacy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">return_inv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">smooth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix that transforms Spherical harmonics (SH) to spherical</span>
<span class="sd">    function (SF).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sphere : Sphere</span>
<span class="sd">        The points on which to sample the spherical function.</span>
<span class="sd">    sh_order_max : int, optional</span>
<span class="sd">        Maximum SH order in the SH fit.  For ``sh_order_max``, there will be</span>
<span class="sd">        ``(sh_order_max + 1) * (sh_order_max + 2) / 2`` SH coefficients for a</span>
<span class="sd">        symmetric basis and ``(sh_order_max + 1) * (sh_order_max + 1)``</span>
<span class="sd">        coefficients for a full SH basis.</span>
<span class="sd">    basis_type : {None, &#39;tournier07&#39;, &#39;descoteaux07&#39;}, optional</span>
<span class="sd">        ``None`` for the default DIPY basis,</span>
<span class="sd">        ``tournier07`` for the Tournier 2007 :footcite:p:`Tournier2007`,</span>
<span class="sd">        :footcite:p:`Tournier2019` basis,</span>
<span class="sd">        ``descoteaux07`` for the Descoteaux 2007 :footcite:p:`Descoteaux2007`</span>
<span class="sd">        basis,</span>
<span class="sd">        (``None`` defaults to ``descoteaux07``).</span>
<span class="sd">    full_basis: bool, optional</span>
<span class="sd">        If True, uses a SH basis containing even and odd order SH functions.</span>
<span class="sd">        Else, uses a SH basis consisting only of even order SH functions.</span>
<span class="sd">    legacy: bool, optional</span>
<span class="sd">        True to use a legacy basis definition for backward compatibility</span>
<span class="sd">        with previous ``tournier07`` and ``descoteaux07`` implementations.</span>
<span class="sd">    return_inv : bool, optional</span>
<span class="sd">        If True then the inverse of the matrix is also returned.</span>
<span class="sd">    smooth : float, optional</span>
<span class="sd">        Lambda-regularization in the SH fit.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    B : ndarray</span>
<span class="sd">        Matrix that transforms spherical harmonics to spherical function</span>
<span class="sd">        ``sf = np.dot(sh, B)``.</span>
<span class="sd">    invB : ndarray</span>
<span class="sd">        Inverse of B.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sph_harm_basis</span> <span class="o">=</span> <span class="n">sph_harm_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">basis_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sph_harm_basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid basis name.&quot;</span><span class="p">)</span>
    <span class="n">B</span><span class="p">,</span> <span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span> <span class="o">=</span> <span class="n">sph_harm_basis</span><span class="p">(</span>
        <span class="n">sh_order_max</span><span class="p">,</span> <span class="n">sphere</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">sphere</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="n">full_basis</span><span class="o">=</span><span class="n">full_basis</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="n">legacy</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">return_inv</span><span class="p">:</span>
        <span class="n">L</span> <span class="o">=</span> <span class="o">-</span><span class="n">l_values</span> <span class="o">*</span> <span class="p">(</span><span class="n">l_values</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">invB</span> <span class="o">=</span> <span class="n">smooth_pinv</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">smooth</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">invB</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span></div>



<div class="viewcode-block" id="calculate_max_order">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.calculate_max_order">[docs]</a>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">calculate_max_order</span><span class="p">(</span><span class="n">n_coeffs</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">full_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Calculate the maximal harmonic order (l), given that you know the</span>
<span class="sd">    number of parameters that were estimated.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_coeffs : int</span>
<span class="sd">        The number of SH coefficients</span>
<span class="sd">    full_basis: bool, optional</span>
<span class="sd">        True if the used SH basis contains even and odd order SH functions.</span>
<span class="sd">        False if the SH basis consists only of even order SH functions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    L : int</span>
<span class="sd">        The maximal SH order (l), given the number of coefficients</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The calculation in this function for the symmetric SH basis</span>
<span class="sd">    proceeds according to the following logic:</span>

<span class="sd">    .. math::</span>

<span class="sd">        n = \frac{1}{2} (L+1) (L+2)</span>
<span class="sd">        \rarrow 2n = L^2 + 3L + 2</span>
<span class="sd">        \rarrow L^2 + 3L + 2 - 2n = 0</span>
<span class="sd">        \rarrow L^2 + 3L + 2(1-n) = 0</span>
<span class="sd">        \rarrow L_{1,2} = \frac{-3 \pm \sqrt{9 - 8 (1-n)}}{2}</span>
<span class="sd">        \rarrow L{1,2} = \frac{-3 \pm \sqrt{1 + 8n}}{2}</span>

<span class="sd">    Finally, the positive value is chosen between the two options.</span>

<span class="sd">    For a full SH basis, the calculation consists in solving the equation</span>
<span class="sd">    $n = (L + 1)^2$ for $L$, which gives $L = sqrt(n) - 1$.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># L2 is negative for all positive values of n_coeffs, so we don&#39;t</span>
    <span class="c1"># bother even computing it:</span>
    <span class="c1"># L2 = (-3 - np.sqrt(1 + 8 * n_coeffs)) / 2</span>
    <span class="c1"># L1 is always the larger value, so we go with that:</span>
    <span class="k">if</span> <span class="n">full_basis</span><span class="p">:</span>
        <span class="n">L1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_coeffs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">L1</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">L1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">L1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">n_coeffs</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="c1"># Check that it is a whole even number:</span>
        <span class="k">if</span> <span class="n">L1</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">L1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">L1</span><span class="p">)</span>

    <span class="c1"># Otherwise, the input didn&#39;t make sense:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;The input to ``calculate_max_order`` was&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">n_coeffs</span><span class="si">}</span><span class="s2">, but that is not a valid number&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; of coefficients for a spherical harmonics&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; basis set.&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="anisotropic_power">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.anisotropic_power">[docs]</a>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">anisotropic_power</span><span class="p">(</span><span class="n">sh_coeffs</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">norm_factor</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">non_negative</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Calculate anisotropic power map with a given SH coefficient matrix.</span>

<span class="sd">    See :footcite:p:`DellAcqua2014` for further details about the method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sh_coeffs : ndarray</span>
<span class="sd">        A ndarray where the last dimension is the</span>
<span class="sd">        SH coefficients estimates for that voxel.</span>
<span class="sd">    norm_factor: float, optional</span>
<span class="sd">        The value to normalize the ap values.</span>
<span class="sd">    power : int, optional</span>
<span class="sd">        The degree to which power maps are calculated.</span>
<span class="sd">    non_negative: bool, optional</span>
<span class="sd">        Whether to rectify the resulting map to be non-negative.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    log_ap : ndarray</span>
<span class="sd">        The log of the resulting power image.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Calculate AP image based on a IxJxKxC SH coefficient matrix based on the</span>
<span class="sd">    equation:</span>

<span class="sd">    .. math::</span>

<span class="sd">        AP = \sum_{l=2,4,6,...}{\frac{1}{2l+1} \sum_{m=-l}^l{|a_{l,m}|^n}}</span>

<span class="sd">    Where the last dimension, C, is made of a flattened array of $l$x$m$</span>
<span class="sd">    coefficients, where $l$ are the SH orders, and $m = 2l+1$,</span>
<span class="sd">    So l=1 has 1 coefficient, l=2 has 5, ... l=8 has 17 and so on.</span>
<span class="sd">    A l=2 SH coefficient matrix will then be composed of a IxJxKx6 volume.</span>
<span class="sd">    The power, $n$ is usually set to $n=2$.</span>

<span class="sd">    The final AP image is then shifted by -log(norm_factor), to be strictly</span>
<span class="sd">    non-negative. Remaining values &lt; 0 are discarded (set to 0), per default,</span>
<span class="sd">    and this option is controlled through the `non_negative` keyword argument.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">sh_coeffs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n_coeffs</span> <span class="o">=</span> <span class="n">sh_coeffs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">max_order</span> <span class="o">=</span> <span class="n">calculate_max_order</span><span class="p">(</span><span class="n">n_coeffs</span><span class="p">)</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
    <span class="n">n_start</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_order</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">n_stop</span> <span class="o">=</span> <span class="n">n_start</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">L</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ap_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sh_coeffs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">n_start</span><span class="p">:</span><span class="n">n_stop</span><span class="p">])</span> <span class="o">**</span> <span class="n">power</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ap</span> <span class="o">+=</span> <span class="n">ap_i</span>
        <span class="n">n_start</span> <span class="o">=</span> <span class="n">n_stop</span>

    <span class="c1"># Shift the map to be mostly non-negative,</span>
    <span class="c1"># only applying the log operation to positive elements</span>
    <span class="c1"># to avoid getting numpy warnings on log(0).</span>
    <span class="c1"># It is impossible to get ap values smaller than 0.</span>
    <span class="c1"># Also avoids getting voxels with -inf when non_negative=False.</span>

    <span class="k">if</span> <span class="n">ap</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># For the off chance we have a scalar on our hands</span>
        <span class="n">ap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
    <span class="n">log_ap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span>
    <span class="n">log_ap</span><span class="p">[</span><span class="n">ap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ap</span><span class="p">[</span><span class="n">ap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">norm_factor</span><span class="p">)</span>

    <span class="c1"># Deal with residual negative values:</span>
    <span class="k">if</span> <span class="n">non_negative</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">log_ap</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="c1"># zero all values &lt; 0</span>
            <span class="n">log_ap</span><span class="p">[</span><span class="n">log_ap</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># assume this is a singleton float (input was 1D):</span>
            <span class="k">if</span> <span class="n">log_ap</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">log_ap</span></div>



<div class="viewcode-block" id="convert_sh_to_full_basis">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.convert_sh_to_full_basis">[docs]</a>
<span class="k">def</span> <span class="nf">convert_sh_to_full_basis</span><span class="p">(</span><span class="n">sh_coeffs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given an array of SH coeffs from a symmetric basis, returns the</span>
<span class="sd">    coefficients for the full SH basis by filling odd order SH coefficients</span>
<span class="sd">    with zeros</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sh_coeffs: ndarray</span>
<span class="sd">        A ndarray where the last dimension is the</span>
<span class="sd">        SH coefficients estimates for that voxel.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    full_sh_coeffs: ndarray</span>
<span class="sd">        A ndarray where the last dimension is the</span>
<span class="sd">        SH coefficients estimates for that voxel in</span>
<span class="sd">        a full SH basis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sh_order_max</span> <span class="o">=</span> <span class="n">calculate_max_order</span><span class="p">(</span><span class="n">sh_coeffs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">sph_harm_ind_list</span><span class="p">(</span><span class="n">sh_order_max</span><span class="p">,</span> <span class="n">full_basis</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">full_sh_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sh_coeffs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">size</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="n">full_sh_coeffs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">sh_coeffs</span>
    <span class="k">return</span> <span class="n">full_sh_coeffs</span></div>



<div class="viewcode-block" id="convert_sh_from_legacy">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.convert_sh_from_legacy">[docs]</a>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">convert_sh_from_legacy</span><span class="p">(</span><span class="n">sh_coeffs</span><span class="p">,</span> <span class="n">sh_basis</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">full_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert SH coefficients in legacy SH basis to SH coefficients</span>
<span class="sd">    of the new SH basis for ``descoteaux07`` or ``tournier07`` bases.</span>

<span class="sd">    See :footcite:p:`Descoteaux2007` and :footcite:p:`Tournier2007`,</span>
<span class="sd">    :footcite:p:`Tournier2019` for the ``descoteaux07`` and ``tournier07``</span>
<span class="sd">    bases, respectively.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sh_coeffs: ndarray</span>
<span class="sd">        A ndarray where the last dimension is the</span>
<span class="sd">        SH coefficients estimates for that voxel.</span>
<span class="sd">    sh_basis: {&#39;descoteaux07&#39;, &#39;tournier07&#39;}</span>
<span class="sd">        ``tournier07`` for the Tournier 2007 :footcite:p:`Tournier2007`,</span>
<span class="sd">        :footcite:p:`Tournier2019` basis,</span>
<span class="sd">        ``descoteaux07`` for the Descoteaux 2007 :footcite:p:`Descoteaux2007`</span>
<span class="sd">        basis.</span>
<span class="sd">    full_basis: bool, optional</span>
<span class="sd">        True if the input SH basis includes both even and odd</span>
<span class="sd">        order SH functions, else False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out_sh_coeffs: ndarray</span>
<span class="sd">        The array of coefficients expressed in the new SH basis.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sh_order_max</span> <span class="o">=</span> <span class="n">calculate_max_order</span><span class="p">(</span><span class="n">sh_coeffs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">full_basis</span><span class="o">=</span><span class="n">full_basis</span><span class="p">)</span>

    <span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span> <span class="o">=</span> <span class="n">sph_harm_ind_list</span><span class="p">(</span><span class="n">sh_order_max</span><span class="p">,</span> <span class="n">full_basis</span><span class="o">=</span><span class="n">full_basis</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sh_basis</span> <span class="o">==</span> <span class="s2">&quot;descoteaux07&quot;</span><span class="p">:</span>
        <span class="n">out_sh_coeffs</span> <span class="o">=</span> <span class="n">sh_coeffs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_values</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">**</span> <span class="n">m_values</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sh_basis</span> <span class="o">==</span> <span class="s2">&quot;tournier07&quot;</span><span class="p">:</span>
        <span class="n">out_sh_coeffs</span> <span class="o">=</span> <span class="n">sh_coeffs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_values</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid basis name.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out_sh_coeffs</span></div>



<div class="viewcode-block" id="convert_sh_to_legacy">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.convert_sh_to_legacy">[docs]</a>
<span class="nd">@warning_for_keywords</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">convert_sh_to_legacy</span><span class="p">(</span><span class="n">sh_coeffs</span><span class="p">,</span> <span class="n">sh_basis</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">full_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert SH coefficients in new SH basis to SH coefficients for</span>
<span class="sd">    the legacy SH basis for ``descoteaux07`` or ``tournier07`` bases.</span>

<span class="sd">    See :footcite:p:`Descoteaux2007` and :footcite:p:`Tournier2007`,</span>
<span class="sd">    :footcite:p:`Tournier2019` for the ``descoteaux07`` and ``tournier07``</span>
<span class="sd">    bases, respectively.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sh_coeffs: ndarray</span>
<span class="sd">        A ndarray where the last dimension is the</span>
<span class="sd">        SH coefficients estimates for that voxel.</span>
<span class="sd">    sh_basis: {&#39;descoteaux07&#39;, &#39;tournier07&#39;}</span>
<span class="sd">        ``tournier07`` for the Tournier 2007 :footcite:p:`Tournier2007`,</span>
<span class="sd">        :footcite:p:`Tournier2019` basis,</span>
<span class="sd">        ``descoteaux07`` for the Descoteaux 2007 :footcite:p:`Descoteaux2007`</span>
<span class="sd">        basis.</span>
<span class="sd">    full_basis: bool, optional</span>
<span class="sd">        True if the input SH basis includes both even and odd</span>
<span class="sd">        order SH functions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out_sh_coeffs: ndarray</span>
<span class="sd">        The array of coefficients expressed in the legacy SH basis.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sh_order_max</span> <span class="o">=</span> <span class="n">calculate_max_order</span><span class="p">(</span><span class="n">sh_coeffs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">full_basis</span><span class="o">=</span><span class="n">full_basis</span><span class="p">)</span>

    <span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span> <span class="o">=</span> <span class="n">sph_harm_ind_list</span><span class="p">(</span><span class="n">sh_order_max</span><span class="p">,</span> <span class="n">full_basis</span><span class="o">=</span><span class="n">full_basis</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sh_basis</span> <span class="o">==</span> <span class="s2">&quot;descoteaux07&quot;</span><span class="p">:</span>
        <span class="n">out_sh_coeffs</span> <span class="o">=</span> <span class="n">sh_coeffs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_values</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">**</span> <span class="n">m_values</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sh_basis</span> <span class="o">==</span> <span class="s2">&quot;tournier07&quot;</span><span class="p">:</span>
        <span class="n">out_sh_coeffs</span> <span class="o">=</span> <span class="n">sh_coeffs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_values</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid basis name.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out_sh_coeffs</span></div>



<div class="viewcode-block" id="convert_sh_descoteaux_tournier">
<a class="viewcode-back" href="../../../reference/dipy.reconst.html#dipy.denoise.shift_twist_convolution.convert_sh_descoteaux_tournier">[docs]</a>
<span class="k">def</span> <span class="nf">convert_sh_descoteaux_tournier</span><span class="p">(</span><span class="n">sh_coeffs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert SH coefficients between legacy-descoteaux07 and tournier07.</span>

<span class="sd">    Convert SH coefficients between the legacy ``descoteaux07`` SH basis and</span>
<span class="sd">    the non-legacy ``tournier07`` SH basis. Because this conversion is equal to</span>
<span class="sd">    its own inverse, it can be used to convert in either direction:</span>
<span class="sd">    legacy-descoteaux to non-legacy-tournier or non-legacy-tournier to</span>
<span class="sd">    legacy-descoteaux.</span>

<span class="sd">    This can be used to convert SH representations between DIPY and MRtrix3.</span>

<span class="sd">    See :footcite:p:`Descoteaux2007` and :footcite:p:`Tournier2019` for the</span>
<span class="sd">    origin of these SH bases.</span>

<span class="sd">    See [mrtrixbasis]_ for a description of the basis used in MRtrix3.</span>
<span class="sd">    See [mrtrixdipybases]_ for more details on the conversion.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sh_coeffs: ndarray</span>
<span class="sd">        A ndarray where the last dimension is the</span>
<span class="sd">        SH coefficients estimates for that voxel.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out_sh_coeffs: ndarray</span>
<span class="sd">        The array of coefficients expressed in the &quot;other&quot; SH basis. If the</span>
<span class="sd">        input was in the legacy-descoteaux basis then the output will be in the</span>
<span class="sd">        non-legacy-tournier basis, and vice versa.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. footbibliography::</span>
<span class="sd">    .. [mrtrixbasis] https://mrtrix.readthedocs.io/en/latest/concepts/spherical_harmonics.html</span>
<span class="sd">    .. [mrtrixdipybases] https://github.com/dipy/dipy/discussions/2959#discussioncomment-7481675</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>

    <span class="n">sh_order_max</span> <span class="o">=</span> <span class="n">calculate_max_order</span><span class="p">(</span><span class="n">sh_coeffs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">m_values</span><span class="p">,</span> <span class="n">l_values</span> <span class="o">=</span> <span class="n">sph_harm_ind_list</span><span class="p">(</span><span class="n">sh_order_max</span><span class="p">)</span>
    <span class="n">basis_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">l_values</span><span class="p">,</span> <span class="n">m_values</span><span class="p">))</span>  <span class="c1"># dipy basis ordering</span>
    <span class="n">basis_indices_permuted</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">l_values</span><span class="p">,</span> <span class="o">-</span><span class="n">m_values</span><span class="p">))</span>  <span class="c1"># mrtrix basis ordering</span>
    <span class="n">permutation</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">basis_indices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">basis_indices_permuted</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basis_indices</span><span class="p">))</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">sh_coeffs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">permutation</span><span class="p">]</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  
<script type="module" src="../../../_static/scripts/grg-sphinx-theme.js"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item"><div>
  <h3 class="footer-heading">
    Never miss an update from us!
  </h3>
  <p class="footer-sub-heading">
    Don't worry! we are not going to spam you.
  </p>
  <div class="input-group mb-3 mar-t-10">
    <input type="text" class="form-control" placeholder="You email" aria-label="You email" id="grg-subscribe-email">
    <div class="input-group-append pointer" onclick="(document.getElementById('grg-subscribe-email').value)">
      <span class="input-group-text subscribe">Subscribe</span>
    </div>
  </div>  
  <ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/dipy" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/dipymri" title="Twitter/X" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter/X</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.youtube.com/c/diffusionimaginginpython" title="YouTube" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-youtube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">YouTube</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.linkedin.com/company/dipy/" title="LinkedIn" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-linkedin fa-lg" aria-hidden="true"></i>
            <span class="sr-only">LinkedIn</span></a>
        </li>
</ul>
</div></div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><div class="grid-3">
  
  <div>
    <h5 class="footer-heading">
      About
    </h5>
    <ul class="footer-section">
      
        
        <li class="pad-v-5">
          <a href="https://dipy.org/team">
            Developers
          </a>
        </li>
        
      
        
        <li class="pad-v-5">
          <a href="https://github.com/dipy/dipy/discussions" target="_blank" rel="noopener noreferrer">
            Support
            <i class="fa-solid fa-arrow-up-long mar-l-5"></i>
          </a>
        </li>
        
      
        
        <li class="pad-v-5">
          <a href="../../../user_guide/installation.html">
            Download
          </a>
        </li>
        
      
        
        <li class="pad-v-5">
          <a href="../../../user_guide/getting_started.html">
            Get Started
          </a>
        </li>
        
      
        
        <li class="pad-v-5">
          <a href="../../../examples_built/index.html">
            Tutorials
          </a>
        </li>
        
      
        
        <li class="pad-v-5">
          <a href="https://www.youtube.com/c/diffusionimaginginpython" target="_blank" rel="noopener noreferrer">
            Videos
            <i class="fa-solid fa-arrow-up-long mar-l-5"></i>
          </a>
        </li>
        
      
    </ul>
  </div>
  
  <div>
    <h5 class="footer-heading">
      Friends
    </h5>
    <ul class="footer-section">
      
        
        <li class="pad-v-5">
          <a href="http://nipy.org/" target="_blank" rel="noopener noreferrer">
            Nipy Projects
            <i class="fa-solid fa-arrow-up-long mar-l-5"></i>
          </a>
        </li>
        
      
        
        <li class="pad-v-5">
          <a href="http://fury.gl/" target="_blank" rel="noopener noreferrer">
            FURY
            <i class="fa-solid fa-arrow-up-long mar-l-5"></i>
          </a>
        </li>
        
      
        
        <li class="pad-v-5">
          <a href="http://nipy.org/nibabel" target="_blank" rel="noopener noreferrer">
            Nibabel
            <i class="fa-solid fa-arrow-up-long mar-l-5"></i>
          </a>
        </li>
        
      
        
        <li class="pad-v-5">
          <a href="https://tortoise.nibib.nih.gov/" target="_blank" rel="noopener noreferrer">
            Tortoise
            <i class="fa-solid fa-arrow-up-long mar-l-5"></i>
          </a>
        </li>
        
      
    </ul>
  </div>
  
  <div>
    <h5 class="footer-heading">
      Support
    </h5>
    <ul class="footer-section">
      
        
        <li class="pad-v-5">
          <a href="https://engineering.indiana.edu/" target="_blank" rel="noopener noreferrer">
            The department of Intelligent Systems Engineering of Indiana University
            <i class="fa-solid fa-arrow-up-long mar-l-5"></i>
          </a>
        </li>
        
      
        
        <li class="pad-v-5">
          <a href="https://www.nibib.nih.gov/" target="_blank" rel="noopener noreferrer">
            The National Institute of Biomedical Imaging and Bioengineering, NIH
            <i class="fa-solid fa-arrow-up-long mar-l-5"></i>
          </a>
        </li>
        
      
        
        <li class="pad-v-5">
          <a href="https://escience.washington.edu" target="_blank" rel="noopener noreferrer">
            The Gordon and Betty Moore Foundation and the Alfred P. Sloan Foundation, through the University of Washington eScience Institute Data Science Environment
            <i class="fa-solid fa-arrow-up-long mar-l-5"></i>
          </a>
        </li>
        
      
        
        <li class="pad-v-5">
          <a href="https://summerofcode.withgoogle.com/" target="_blank" rel="noopener noreferrer">
            Google supported DIPY through the Google Summer of Code Program (2015-2024)
            <i class="fa-solid fa-arrow-up-long mar-l-5"></i>
          </a>
        </li>
        
      
    </ul>
  </div>
  
</div></div>
      
    </div>
  
</div>

    <div class="copyright-text">
      <i class="fa-regular fa-copyright"></i> Copyright 2008-2024,DIPY developers. Created using Grg Sphinx Theme and PyData Sphinx Theme.
    </div>
  </footer>
  </body>
</html>