
<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>DIPY &#8212; dipy 1.8.0dev0 documentation</title>
  
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/dipy.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

  
<link rel="stylesheet" href="../../_static/styles/grg-sphinx-theme.css"/>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'examples_built/contextual_enhancement/fiber_to_bundle_coherence';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

  <meta name="keywords" content="DIPY, dMRI, DTI, DSI, diffusion MRI, Tensor,
  neuroimaging, python, neuroscience, Eleftherios, Garyfallidis, tractography,
  streamlines, fiber tracking">




  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
<nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    <p class="title logo__title">dipy 1.8.0dev0 documentation</p>
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../documentation.html">
                        Documentation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../stateoftheart.html">
                        A quick overview of features
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

</nav>
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../documentation.html">
                        Documentation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../stateoftheart.html">
                        A quick overview of features
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">DIPY</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
<div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-examples-built-contextual-enhancement-fiber-to-bundle-coherence-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="fiber-to-bundle-coherence-measures">
<span id="sphx-glr-examples-built-contextual-enhancement-fiber-to-bundle-coherence-py"></span><h1>Fiber to bundle coherence measures<a class="headerlink" href="#fiber-to-bundle-coherence-measures" title="Permalink to this heading">#</a></h1>
<p>This demo presents the fiber to bundle coherence (FBC) quantitative
measure of the alignment of each fiber with the surrounding fiber bundles
<a class="reference internal" href="#meesters2016" id="id1"><span>[Meesters2016]</span></a>. These measures are useful in ‘cleaning’ the results of
tractography algorithms, since low FBCs indicate which fibers are isolated and
poorly aligned with their neighbors, as shown in the figure below.</p>
<figure class="align-center" id="id7">
<span id="fiber-to-bundle-coherence"></span><a class="reference internal image-reference" href="examples_built/contextual_enhancement/_static/fbc_illustration.png"><img alt="examples_built/contextual_enhancement/_static/fbc_illustration.png" src="examples_built/contextual_enhancement/_static/fbc_illustration.png" /></a>
<figcaption>
<p><span class="caption-text">On the left this figure illustrates (in 2D) the contribution of two fiber
points to the kernel density estimator. The kernel density estimator is the
sum over all such locally aligned kernels. The local fiber to bundle
coherence, shown on the right, color-coded for each fiber, is obtained by
evaluating the kernel density estimator along the fibers. One spurious
fiber is present which is isolated and badly aligned with the other fibers,
and can be identified by a low LFBC value in the region where it deviates
from the bundle. Figure adapted from <a class="reference internal" href="#portegies2015" id="id2"><span>[Portegies2015]</span></a>.</span><a class="headerlink" href="#id7" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>Here we implement FBC measures based on kernel density estimation in the
non-flat 5D position-orientation domain. First we compute the kernel density
estimator induced by the full lifted output (defined in the space of positions
and orientations) of the tractography. Then, the Local FBC (LFBC) is the
result of evaluating the estimator along each element of the lifted fiber.
A whole fiber measure, the relative FBC (RFBC), is calculated
by the minimum of the moving average LFBC along the fiber.
Details of the computation of FBC can be found in <a class="reference internal" href="#portegies2015" id="id3"><span>[Portegies2015]</span></a>.</p>
<p>The FBC measures are evaluated on the Stanford HARDI dataset
(150 orientations, b=2000 <span class="math notranslate nohighlight">\(s/mm^2\)</span>) which is one of the standard example
datasets in <a class="reference external" href="http://dipy.org">DIPY</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Enables/disables interactive visualization</span>
<span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">dipy.core.gradients</span> <span class="kn">import</span> <span class="n">gradient_table</span>
<span class="kn">from</span> <span class="nn">dipy.data</span> <span class="kn">import</span> <span class="n">get_fnames</span>
<span class="kn">from</span> <span class="nn">dipy.io.image</span> <span class="kn">import</span> <span class="n">load_nifti_data</span><span class="p">,</span> <span class="n">load_nifti</span>
<span class="kn">from</span> <span class="nn">dipy.io.gradients</span> <span class="kn">import</span> <span class="n">read_bvals_bvecs</span>

<span class="c1"># Fix seed</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Read data</span>
<span class="n">hardi_fname</span><span class="p">,</span> <span class="n">hardi_bval_fname</span><span class="p">,</span> <span class="n">hardi_bvec_fname</span> <span class="o">=</span> <span class="n">get_fnames</span><span class="p">(</span><span class="s1">&#39;stanford_hardi&#39;</span><span class="p">)</span>
<span class="n">label_fname</span> <span class="o">=</span> <span class="n">get_fnames</span><span class="p">(</span><span class="s1">&#39;stanford_labels&#39;</span><span class="p">)</span>
<span class="n">t1_fname</span> <span class="o">=</span> <span class="n">get_fnames</span><span class="p">(</span><span class="s1">&#39;stanford_t1&#39;</span><span class="p">)</span>

<span class="n">data</span><span class="p">,</span> <span class="n">affine</span> <span class="o">=</span> <span class="n">load_nifti</span><span class="p">(</span><span class="n">hardi_fname</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">load_nifti_data</span><span class="p">(</span><span class="n">label_fname</span><span class="p">)</span>
<span class="n">t1_data</span> <span class="o">=</span> <span class="n">load_nifti_data</span><span class="p">(</span><span class="n">t1_fname</span><span class="p">)</span>
<span class="n">bvals</span><span class="p">,</span> <span class="n">bvecs</span> <span class="o">=</span> <span class="n">read_bvals_bvecs</span><span class="p">(</span><span class="n">hardi_bval_fname</span><span class="p">,</span> <span class="n">hardi_bvec_fname</span><span class="p">)</span>
<span class="n">gtab</span> <span class="o">=</span> <span class="n">gradient_table</span><span class="p">(</span><span class="n">bvals</span><span class="p">,</span> <span class="n">bvecs</span><span class="p">)</span>



<span class="c1"># Select a relevant part of the data (left hemisphere)</span>
<span class="c1"># Coordinates given in x bounds, y bounds, z bounds</span>
<span class="n">dshape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">xa</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">ya</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">za</span><span class="p">,</span> <span class="n">zb</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">65</span><span class="p">]</span>
<span class="n">data_small</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">xa</span><span class="p">:</span><span class="n">xb</span><span class="p">,</span> <span class="n">ya</span><span class="p">:</span><span class="n">yb</span><span class="p">,</span> <span class="n">za</span><span class="p">:</span><span class="n">zb</span><span class="p">]</span>
<span class="n">selectionmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dshape</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)</span>
<span class="n">selectionmask</span><span class="p">[</span><span class="n">xa</span><span class="p">:</span><span class="n">xb</span><span class="p">,</span> <span class="n">ya</span><span class="p">:</span><span class="n">yb</span><span class="p">,</span> <span class="n">za</span><span class="p">:</span><span class="n">zb</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>The data is first fitted to the Constant Solid Angle (CDA) ODF Model. CSA is a
good choice to estimate general fractional anisotropy (GFA), which the stopping
criterion can use to restrict fiber tracking to those areas where the ODF
shows significant restricted diffusion, thus creating a region-of-interest in
which the computations are done.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform CSA</span>
<span class="kn">from</span> <span class="nn">dipy.reconst.shm</span> <span class="kn">import</span> <span class="n">CsaOdfModel</span>
<span class="kn">from</span> <span class="nn">dipy.data</span> <span class="kn">import</span> <span class="n">default_sphere</span>
<span class="kn">from</span> <span class="nn">dipy.direction</span> <span class="kn">import</span> <span class="n">peaks_from_model</span>

<span class="n">csa_model</span> <span class="o">=</span> <span class="n">CsaOdfModel</span><span class="p">(</span><span class="n">gtab</span><span class="p">,</span> <span class="n">sh_order</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">csa_peaks</span> <span class="o">=</span> <span class="n">peaks_from_model</span><span class="p">(</span><span class="n">csa_model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">default_sphere</span><span class="p">,</span>
                             <span class="n">relative_peak_threshold</span><span class="o">=</span><span class="mf">.6</span><span class="p">,</span>
                             <span class="n">min_separation_angle</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span>
                             <span class="n">mask</span><span class="o">=</span><span class="n">selectionmask</span><span class="p">)</span>

<span class="c1"># Stopping Criterion</span>
<span class="kn">from</span> <span class="nn">dipy.tracking.stopping_criterion</span> <span class="kn">import</span> <span class="n">ThresholdStoppingCriterion</span>

<span class="n">stopping_criterion</span> <span class="o">=</span> <span class="n">ThresholdStoppingCriterion</span><span class="p">(</span><span class="n">csa_peaks</span><span class="o">.</span><span class="n">gfa</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
</pre></div>
</div>
<p>In order to perform probabilistic fiber tracking we first fit the data to the
Constrained Spherical Deconvolution (CSD) model in DIPY. This model represents
each voxel in the data set as a collection of small white matter fibers with
different orientations. The density of fibers along each orientation is known
as the Fiber Orientation Distribution (FOD), used in the fiber tracking.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform CSD on the original data</span>
<span class="kn">from</span> <span class="nn">dipy.reconst.csdeconv</span> <span class="kn">import</span> <span class="n">auto_response_ssst</span>
<span class="kn">from</span> <span class="nn">dipy.reconst.csdeconv</span> <span class="kn">import</span> <span class="n">ConstrainedSphericalDeconvModel</span>

<span class="n">response</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="n">auto_response_ssst</span><span class="p">(</span><span class="n">gtab</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">roi_radii</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fa_thr</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">csd_model</span> <span class="o">=</span> <span class="n">ConstrainedSphericalDeconvModel</span><span class="p">(</span><span class="n">gtab</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
<span class="n">csd_fit</span> <span class="o">=</span> <span class="n">csd_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_small</span><span class="p">)</span>
<span class="n">csd_fit_shm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">csd_fit</span><span class="o">.</span><span class="n">shm_coeff</span><span class="p">,</span> <span class="p">((</span><span class="n">xa</span><span class="p">,</span> <span class="n">dshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xb</span><span class="p">),</span>
                                             <span class="p">(</span><span class="n">ya</span><span class="p">,</span> <span class="n">dshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">yb</span><span class="p">),</span>
                                             <span class="p">(</span><span class="n">za</span><span class="p">,</span> <span class="n">dshape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">zb</span><span class="p">),</span>
                                             <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>

<span class="c1"># Probabilistic direction getting for fiber tracking</span>
<span class="kn">from</span> <span class="nn">dipy.direction</span> <span class="kn">import</span> <span class="n">ProbabilisticDirectionGetter</span>

<span class="n">prob_dg</span> <span class="o">=</span> <span class="n">ProbabilisticDirectionGetter</span><span class="o">.</span><span class="n">from_shcoeff</span><span class="p">(</span><span class="n">csd_fit_shm</span><span class="p">,</span>
                                                    <span class="n">max_angle</span><span class="o">=</span><span class="mf">30.</span><span class="p">,</span>
                                                    <span class="n">sphere</span><span class="o">=</span><span class="n">default_sphere</span><span class="p">)</span>
</pre></div>
</div>
<p>The optic radiation is reconstructed by tracking fibers from the calcarine
sulcus (visual cortex V1) to the lateral geniculate nucleus (LGN). We seed
from the calcarine sulcus by selecting a region-of-interest (ROI) cube of
dimensions 3x3x3 voxels.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set a seed region region for tractography.</span>
<span class="kn">from</span> <span class="nn">dipy.tracking</span> <span class="kn">import</span> <span class="n">utils</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;bool&#39;</span><span class="p">)</span>
<span class="n">rad</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">mask</span><span class="p">[</span><span class="mi">26</span><span class="o">-</span><span class="n">rad</span><span class="p">:</span><span class="mi">26</span><span class="o">+</span><span class="n">rad</span><span class="p">,</span> <span class="mi">29</span><span class="o">-</span><span class="n">rad</span><span class="p">:</span><span class="mi">29</span><span class="o">+</span><span class="n">rad</span><span class="p">,</span> <span class="mi">31</span><span class="o">-</span><span class="n">rad</span><span class="p">:</span><span class="mi">31</span><span class="o">+</span><span class="n">rad</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">seeds_from_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">affine</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
<p>Local Tracking is used for probabilistic tractography which takes the
direction getter along with the stopping criterion and seeds as input.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform tracking using Local Tracking</span>
<span class="kn">from</span> <span class="nn">dipy.tracking.local_tracking</span> <span class="kn">import</span> <span class="n">LocalTracking</span>

<span class="n">streamlines_generator</span> <span class="o">=</span> <span class="n">LocalTracking</span><span class="p">(</span><span class="n">prob_dg</span><span class="p">,</span> <span class="n">stopping_criterion</span><span class="p">,</span> <span class="n">seeds</span><span class="p">,</span>
                                      <span class="n">affine</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>

<span class="c1"># Compute streamlines.</span>
<span class="kn">from</span> <span class="nn">dipy.tracking.streamline</span> <span class="kn">import</span> <span class="n">Streamlines</span>
<span class="n">streamlines</span> <span class="o">=</span> <span class="n">Streamlines</span><span class="p">(</span><span class="n">streamlines_generator</span><span class="p">)</span>
</pre></div>
</div>
<p>In order to select only the fibers that enter into the LGN, another ROI is
created from a cube of size 5x5x5 voxels. The near_roi command is used to find
the fibers that traverse through this ROI.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set a mask for the lateral geniculate nucleus (LGN)</span>
<span class="n">mask_lgn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;bool&#39;</span><span class="p">)</span>
<span class="n">rad</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">mask_lgn</span><span class="p">[</span><span class="mi">35</span><span class="o">-</span><span class="n">rad</span><span class="p">:</span><span class="mi">35</span><span class="o">+</span><span class="n">rad</span><span class="p">,</span> <span class="mi">42</span><span class="o">-</span><span class="n">rad</span><span class="p">:</span><span class="mi">42</span><span class="o">+</span><span class="n">rad</span><span class="p">,</span> <span class="mi">28</span><span class="o">-</span><span class="n">rad</span><span class="p">:</span><span class="mi">28</span><span class="o">+</span><span class="n">rad</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Select all the fibers that enter the LGN and discard all others</span>
<span class="n">filtered_fibers2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">near_roi</span><span class="p">(</span><span class="n">streamlines</span><span class="p">,</span> <span class="n">affine</span><span class="p">,</span> <span class="n">mask_lgn</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1.8</span><span class="p">)</span>

<span class="n">sfil</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">streamlines</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">filtered_fibers2</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
        <span class="n">sfil</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">streamlines</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">streamlines</span> <span class="o">=</span> <span class="n">Streamlines</span><span class="p">(</span><span class="n">sfil</span><span class="p">)</span>
</pre></div>
</div>
<p>Inspired by <a class="reference internal" href="#rodrigues2010" id="id4"><span>[Rodrigues2010]</span></a>, a lookup-table is created, containing rotated
versions of the fiber propagation kernel <span class="math notranslate nohighlight">\(P_t\)</span> <a class="reference internal" href="#duitsandfranken2011" id="id5"><span>[DuitsAndFranken2011]</span></a>
rotated over a discrete set of orientations. See the
<a class="reference internal" href="contextual_enhancement.html#sphx-glr-examples-built-contextual-enhancement-contextual-enhancement-py"><span class="std std-ref">Crossing-preserving contextual enhancement</span></a>
example for more details regarding the kernel. In order to ensure rotationally
invariant processing, the discrete orientations are required to be equally
distributed over a sphere. By default, a sphere with 100 directions is obtained
from electrostatic repulsion in DIPY.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute lookup table</span>
<span class="kn">from</span> <span class="nn">dipy.denoise.enhancement_kernel</span> <span class="kn">import</span> <span class="n">EnhancementKernel</span>

<span class="n">D33</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">D44</span> <span class="o">=</span> <span class="mf">0.02</span>
<span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">EnhancementKernel</span><span class="p">(</span><span class="n">D33</span><span class="p">,</span> <span class="n">D44</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
<p>The FBC measures are now computed, taking the tractography results and the
lookup tables as input.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply FBC measures</span>
<span class="kn">from</span> <span class="nn">dipy.tracking.fbcmeasures</span> <span class="kn">import</span> <span class="n">FBCMeasures</span>

<span class="n">fbc</span> <span class="o">=</span> <span class="n">FBCMeasures</span><span class="p">(</span><span class="n">streamlines</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
<p>After calculating the FBC measures, a threshold can be chosen on the relative
FBC (RFBC) in order to remove spurious fibers. Recall that the relative FBC
(RFBC) is calculated by the minimum of the moving average LFBC along the fiber.
In this example we show the results for threshold 0 (i.e. all fibers are
included) and 0.2 (removing the 20 percent most spurious fibers).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate LFBC for original fibers</span>
<span class="n">fbc_sl_orig</span><span class="p">,</span> <span class="n">clrs_orig</span><span class="p">,</span> <span class="n">rfbc_orig</span> <span class="o">=</span> \
  <span class="n">fbc</span><span class="o">.</span><span class="n">get_points_rfbc_thresholded</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">emphasis</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

<span class="c1"># Apply a threshold on the RFBC to remove spurious fibers</span>
<span class="n">fbc_sl_thres</span><span class="p">,</span> <span class="n">clrs_thres</span><span class="p">,</span> <span class="n">rfbc_thres</span> <span class="o">=</span> \
  <span class="n">fbc</span><span class="o">.</span><span class="n">get_points_rfbc_thresholded</span><span class="p">(</span><span class="mf">0.125</span><span class="p">,</span> <span class="n">emphasis</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>The results of FBC measures are visualized, showing the original fibers
colored by LFBC (see <a class="reference internal" href="#optic-radiation-before-cleaning"><span class="std std-ref">The optic radiation obtained through probabilistic tractography colored by
local fiber to bundle coherence.</span></a>), and the fibers
after the cleaning procedure via RFBC thresholding (see
<a class="reference internal" href="#optic-radiation-after-cleaning"><span class="std std-ref">The tractography result is cleaned (shown in bottom) by removing fibers
with a relative FBC (RFBC) lower than the threshold \tau = 0.2.</span></a>).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the results</span>
<span class="kn">from</span> <span class="nn">dipy.viz</span> <span class="kn">import</span> <span class="n">window</span><span class="p">,</span> <span class="n">actor</span>

<span class="c1"># Create scene</span>
<span class="n">scene</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">Scene</span><span class="p">()</span>

<span class="c1"># Original lines colored by LFBC</span>
<span class="n">lineactor</span> <span class="o">=</span> <span class="n">actor</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">fbc_sl_orig</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">clrs_orig</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">scene</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lineactor</span><span class="p">)</span>

<span class="c1"># Horizontal (axial) slice of T1 data</span>
<span class="n">vol_actor1</span> <span class="o">=</span> <span class="n">actor</span><span class="o">.</span><span class="n">slicer</span><span class="p">(</span><span class="n">t1_data</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">affine</span><span class="p">)</span>
<span class="n">vol_actor1</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">scene</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vol_actor1</span><span class="p">)</span>

<span class="c1"># Vertical (sagittal) slice of T1 data</span>
<span class="n">vol_actor2</span> <span class="o">=</span> <span class="n">actor</span><span class="o">.</span><span class="n">slicer</span><span class="p">(</span><span class="n">t1_data</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">affine</span><span class="p">)</span>
<span class="n">vol_actor2</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">35</span><span class="p">)</span>
<span class="n">scene</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vol_actor2</span><span class="p">)</span>

<span class="c1"># Show original fibers</span>
<span class="n">scene</span><span class="o">.</span><span class="n">set_camera</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">264</span><span class="p">,</span> <span class="mi">285</span><span class="p">,</span> <span class="mi">155</span><span class="p">),</span>
                 <span class="n">focal_point</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">14</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
                 <span class="n">view_up</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">window</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_path</span><span class="o">=</span><span class="s1">&#39;OR_before.png&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">900</span><span class="p">,</span> <span class="mi">900</span><span class="p">))</span>
<span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
    <span class="n">window</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>

<span class="c1"># Show thresholded fibers</span>
<span class="n">scene</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">lineactor</span><span class="p">)</span>
<span class="n">scene</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">actor</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">fbc_sl_thres</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">clrs_thres</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">))</span>
<span class="n">window</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_path</span><span class="o">=</span><span class="s1">&#39;OR_after.png&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">900</span><span class="p">,</span> <span class="mi">900</span><span class="p">))</span>
<span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
    <span class="n">window</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-center" id="id8">
<span id="optic-radiation-before-cleaning"></span><img alt="examples_built/contextual_enhancement/OR_before.png" src="examples_built/contextual_enhancement/OR_before.png" />
<figcaption>
<p><span class="caption-text">The optic radiation obtained through probabilistic tractography colored by
local fiber to bundle coherence.</span><a class="headerlink" href="#id8" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<figure class="align-center" id="id9">
<span id="optic-radiation-after-cleaning"></span><img alt="examples_built/contextual_enhancement/OR_after.png" src="examples_built/contextual_enhancement/OR_after.png" />
<figcaption>
<p><span class="caption-text">The tractography result is cleaned (shown in bottom) by removing fibers
with a relative FBC (RFBC) lower than the threshold <span class="math notranslate nohighlight">\(\tau = 0.2\)</span>.</span><a class="headerlink" href="#id9" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<section id="acknowledgments">
<h2>Acknowledgments<a class="headerlink" href="#acknowledgments" title="Permalink to this heading">#</a></h2>
<p>The techniques are developed in close collaboration with Pauly Ossenblok of
the Academic Center of Epileptology Kempenhaeghe &amp; Maastricht UMC+.</p>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this heading">#</a></h2>
<div role="list" class="citation-list">
<div class="citation" id="meesters2016" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">Meesters2016</a><span class="fn-bracket">]</span></span>
<p>S. Meesters, G. Sanguinetti, E. Garyfallidis, J. Portegies,
P. Ossenblok, R. Duits. (2016) Cleaning output of tractography via fiber to
bundle coherence, a new open source implementation. Human Brain Mapping
Conference 2016.</p>
</div>
<div class="citation" id="portegies2015" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>Portegies2015<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id2">1</a>,<a role="doc-backlink" href="#id3">2</a>)</span>
<p>J. Portegies, R. Fick, G. Sanguinetti, S. Meesters,
G.Girard, and R. Duits. (2015) Improving Fiber Alignment in HARDI by
Combining Contextual PDE flow with Constrained Spherical Deconvolution. PLoS
One.</p>
</div>
<div class="citation" id="duitsandfranken2011" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">DuitsAndFranken2011</a><span class="fn-bracket">]</span></span>
<p>R. Duits and E. Franken (2011) Left-invariant
diffusions on the space of positions and orientations and their application
to crossing-preserving smoothing of HARDI images. International Journal of
Computer Vision, 92:231-264.</p>
</div>
<div class="citation" id="rodrigues2010" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">Rodrigues2010</a><span class="fn-bracket">]</span></span>
<p>P. Rodrigues, R. Duits, B. Romeny, A. Vilanova (2010).
Accelerated Diffusion Operators for Enhancing DW-MRI. Eurographics Workshop
on Visual Computing for Biology and Medicine. The Eurographics Association.</p>
</div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  0.000 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-examples-built-contextual-enhancement-fiber-to-bundle-coherence-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/d5063709d677dba8400546d3888b3d48/fiber_to_bundle_coherence.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">fiber_to_bundle_coherence.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/7c1654238a1bbfaed4d33aa754a02f59/fiber_to_bundle_coherence.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">fiber_to_bundle_coherence.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>

<div class="section ablog__blog_comments">
  
  
</div>

                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#acknowledgments">Acknowledgments</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  
<script type="module" src="../../_static/scripts/grg-sphinx-theme.js"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2008-2023, dipy developers &lt;neuroimaging@python.org&gt;.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.0.0.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

    <div class="copyright-text">
      <i class="fa-regular fa-copyright"></i> 
    </div>
  </footer>
  </body>
</html>