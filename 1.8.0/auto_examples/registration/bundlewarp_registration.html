
<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>DIPY &#8212; dipy 1.8.0dev0 documentation</title>
  
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/dipy.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

  
<link rel="stylesheet" href="../../_static/styles/grg-sphinx-theme.css"/>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'auto_examples/registration/bundlewarp_registration';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

  <meta name="keywords" content="DIPY, dMRI, DTI, DSI, diffusion MRI, Tensor,
  neuroimaging, python, neuroscience, Eleftherios, Garyfallidis, tractography,
  streamlines, fiber tracking">




  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
<nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    <p class="title logo__title">dipy 1.8.0dev0 documentation</p>
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../documentation.html">
                        Documentation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../stateoftheart.html">
                        A quick overview of features
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

</nav>
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../documentation.html">
                        Documentation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../stateoftheart.html">
                        A quick overview of features
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="bundle_group_registration.html">Groupwise Bundle Registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="bundle_registration.html">Direct Bundle Registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="syn_registration_3d.html">Symmetric Diffeomorphic Registration in 3D</a></li>
<li class="toctree-l1"><a class="reference internal" href="register_binary_fuzzy.html">Diffeomorphic Registration with binary and fuzzy images</a></li>
<li class="toctree-l1"><a class="reference internal" href="syn_registration_2d.html">Symmetric Diffeomorphic Registration in 2D</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Nonrigid Bundle Registration with BundleWarp</a></li>
<li class="toctree-l1"><a class="reference internal" href="affine_registration_masks.html">Affine Registration with Masks</a></li>
<li class="toctree-l1"><a class="reference internal" href="streamline_registration.html">Applying image-based deformations to streamlines</a></li>
<li class="toctree-l1"><a class="reference internal" href="affine_registration_3d.html">Affine Registration in 3D</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">DIPY</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
<div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-examples-registration-bundlewarp-registration-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="nonrigid-bundle-registration-with-bundlewarp">
<span id="sphx-glr-auto-examples-registration-bundlewarp-registration-py"></span><h1>Nonrigid Bundle Registration with BundleWarp<a class="headerlink" href="#nonrigid-bundle-registration-with-bundlewarp" title="Permalink to this heading">#</a></h1>
<p>This example explains how you can nonlinearly register two bundles from two
different subjects directly in the space of streamlines <a class="reference internal" href="../../examples_built/registration/bundlewarp_registration.html#chandio23" id="id1"><span>[Chandio23]</span></a>, <a class="reference internal" href="../../interfaces/buan_flow.html#chandio20" id="id2"><span>[Chandio20]</span></a>.</p>
<p>To show the concept, we will use two pre-saved uncinate fasciculus bundles. The
algorithm used here is called BundleWarp, streamline-based nonlinear
registration of white matter tracts <a class="reference internal" href="../../examples_built/registration/bundlewarp_registration.html#chandio23" id="id3"><span>[Chandio23]</span></a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">pjoin</span>

<span class="kn">from</span> <span class="nn">dipy.align.streamwarp</span> <span class="kn">import</span> <span class="p">(</span><a href="../../reference/dipy.align.html#dipy.align.streamwarp.bundlewarp" title="dipy.align.streamwarp.bundlewarp" class="sphx-glr-backref-module-dipy-align-streamwarp sphx-glr-backref-type-py-function"><span class="n">bundlewarp</span></a><span class="p">,</span> <a href="../../reference/dipy.align.html#dipy.align.streamwarp.bundlewarp_vector_filed" title="dipy.align.streamwarp.bundlewarp_vector_filed" class="sphx-glr-backref-module-dipy-align-streamwarp sphx-glr-backref-type-py-function"><span class="n">bundlewarp_vector_filed</span></a><span class="p">,</span>
                                   <a href="../../reference/dipy.align.html#dipy.align.streamwarp.bundlewarp_shape_analysis" title="dipy.align.streamwarp.bundlewarp_shape_analysis" class="sphx-glr-backref-module-dipy-align-streamwarp sphx-glr-backref-type-py-function"><span class="n">bundlewarp_shape_analysis</span></a><span class="p">)</span>
<span class="kn">from</span> <span class="nn">dipy.data</span> <span class="kn">import</span> <span class="n">fetch_bundle_warp_dataset</span>
<span class="kn">from</span> <span class="nn">dipy.io.stateful_tractogram</span> <span class="kn">import</span> <span class="n">Space</span><span class="p">,</span> <a href="../../reference/dipy.io.html#dipy.io.stateful_tractogram.StatefulTractogram" title="dipy.io.stateful_tractogram.StatefulTractogram" class="sphx-glr-backref-module-dipy-io-stateful_tractogram sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">StatefulTractogram</span></a>
<span class="kn">from</span> <span class="nn">dipy.io.streamline</span> <span class="kn">import</span> <a href="../../reference/dipy.io.html#dipy.io.streamline.save_tractogram" title="dipy.io.streamline.save_tractogram" class="sphx-glr-backref-module-dipy-io-streamline sphx-glr-backref-type-py-function"><span class="n">save_tractogram</span></a><span class="p">,</span> <a href="../../reference/dipy.io.html#dipy.io.streamline.load_trk" title="dipy.io.streamline.load_trk" class="sphx-glr-backref-module-dipy-io-streamline sphx-glr-backref-type-py-function"><span class="n">load_trk</span></a>
<span class="kn">from</span> <span class="nn">dipy.tracking.streamline</span> <span class="kn">import</span> <span class="p">(</span><span class="n">set_number_of_points</span><span class="p">,</span> <a href="../../reference/dipy.tracking.html#dipy.tracking.streamline.unlist_streamlines" title="dipy.tracking.streamline.unlist_streamlines" class="sphx-glr-backref-module-dipy-tracking-streamline sphx-glr-backref-type-py-function"><span class="n">unlist_streamlines</span></a><span class="p">,</span>
                                      <span class="n">Streamlines</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">dipy.viz.streamline</span> <span class="kn">import</span> <span class="p">(</span><a href="../../reference/dipy.viz.html#dipy.viz.streamline.viz_two_bundles" title="dipy.viz.streamline.viz_two_bundles" class="sphx-glr-backref-module-dipy-viz-streamline sphx-glr-backref-type-py-function"><span class="n">viz_two_bundles</span></a><span class="p">,</span> <a href="../../reference/dipy.viz.html#dipy.viz.streamline.viz_vector_field" title="dipy.viz.streamline.viz_vector_field" class="sphx-glr-backref-module-dipy-viz-streamline sphx-glr-backref-type-py-function"><span class="n">viz_vector_field</span></a><span class="p">,</span>
                                 <a href="../../reference/dipy.viz.html#dipy.viz.streamline.viz_displacement_mag" title="dipy.viz.streamline.viz_displacement_mag" class="sphx-glr-backref-module-dipy-viz-streamline sphx-glr-backref-type-py-function"><span class="n">viz_displacement_mag</span></a><span class="p">)</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
</pre></div>
</div>
<p>Let’s download and loaf two uncinate fasciculus bundles in the left hemisphere
of the brain (UF_L) available here:
<a class="reference external" href="https://figshare.com/articles/dataset/Test_Bundles_for_DIPY/22557733">https://figshare.com/articles/dataset/Test_Bundles_for_DIPY/22557733</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bundle_warp_files</span> <span class="o">=</span> <span class="n">fetch_bundle_warp_dataset</span><span class="p">()</span>
<span class="n">s_UF_L_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">bundle_warp_files</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;s_UF_L.trk&#39;</span><span class="p">)</span>
<span class="n">m_UF_L_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">bundle_warp_files</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;m_UF_L.trk&#39;</span><span class="p">)</span>

<span class="n">uf_subj1</span> <span class="o">=</span> <a href="../../reference/dipy.io.html#dipy.io.streamline.load_trk" title="dipy.io.streamline.load_trk" class="sphx-glr-backref-module-dipy-io-streamline sphx-glr-backref-type-py-function"><span class="n">load_trk</span></a><span class="p">(</span><span class="n">s_UF_L_path</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
                    <span class="n">bbox_valid_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">streamlines</span>
<span class="n">uf_subj2</span> <span class="o">=</span> <a href="../../reference/dipy.io.html#dipy.io.streamline.load_trk" title="dipy.io.streamline.load_trk" class="sphx-glr-backref-module-dipy-io-streamline sphx-glr-backref-type-py-function"><span class="n">load_trk</span></a><span class="p">(</span><span class="n">m_UF_L_path</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
                    <span class="n">bbox_valid_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">streamlines</span>
</pre></div>
</div>
<p>Let’s resample the streamlines so that they both have the same number of points
per streamline. Here we will use 20 points.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="o">=</span> <span class="n">Streamlines</span><span class="p">(</span><span class="n">set_number_of_points</span><span class="p">(</span><span class="n">uf_subj1</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">moving</span> <span class="o">=</span> <span class="n">Streamlines</span><span class="p">(</span><span class="n">set_number_of_points</span><span class="p">(</span><span class="n">uf_subj2</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
</pre></div>
</div>
<p>We call <code class="docutils literal notranslate"><span class="pre">uf_subj2</span></code> a moving bundle as it will be nonlinearly aligned with
<code class="docutils literal notranslate"><span class="pre">uf_subj1</span></code> (static) bundle. Here is how this is done.</p>
<p>Let’s visualize static bundle in red and moving in green before registration.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><a href="../../reference/dipy.viz.html#dipy.viz.streamline.viz_two_bundles" title="dipy.viz.streamline.viz_two_bundles" class="sphx-glr-backref-module-dipy-viz-streamline sphx-glr-backref-type-py-function"><span class="n">viz_two_bundles</span></a><span class="p">(</span><span class="n">static</span><span class="p">,</span> <span class="n">moving</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s2">&quot;static_and_moving.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>BundleWarp method provides a unique ability to either partially or fully deform
a moving bundle by the use of a single regularization parameter alpha.
alpha controls the trade-off between regularizing the deformation and having
points match very closely. The lower the value of alpha, the more closely the
bundles would match.</p>
<p>Let’s partially deform bundle by setting alpha=0.5.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">deformed_bundle</span><span class="p">,</span> <span class="n">moving_aligned</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">match_pairs</span><span class="p">,</span> <span class="n">warp_map</span> <span class="o">=</span> <a href="../../reference/dipy.align.html#dipy.align.streamwarp.bundlewarp" title="dipy.align.streamwarp.bundlewarp" class="sphx-glr-backref-module-dipy-align-streamwarp sphx-glr-backref-type-py-function"><span class="n">bundlewarp</span></a><span class="p">(</span>
                               <span class="n">static</span><span class="p">,</span> <span class="n">moving</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time taken by BundleWarp registration in seconds = &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s visualize static bundle in red and moved (warped) in green. Note: You can
set interactive=True in visualization functions throughout this tutorial if you
prefer to get interactive visualization window.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><a href="../../reference/dipy.viz.html#dipy.viz.streamline.viz_two_bundles" title="dipy.viz.streamline.viz_two_bundles" class="sphx-glr-backref-module-dipy-viz-streamline sphx-glr-backref-type-py-function"><span class="n">viz_two_bundles</span></a><span class="p">(</span><span class="n">static</span><span class="p">,</span> <span class="n">deformed_bundle</span><span class="p">,</span>
                <span class="n">fname</span><span class="o">=</span><span class="s2">&quot;static_and_partially_deformed.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s visualize linearly moved bundle in blue and nonlinearly moved bundle in
green to see BundleWarp registration improvement over linear SLR registration.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><a href="../../reference/dipy.viz.html#dipy.viz.streamline.viz_two_bundles" title="dipy.viz.streamline.viz_two_bundles" class="sphx-glr-backref-module-dipy-viz-streamline sphx-glr-backref-type-py-function"><span class="n">viz_two_bundles</span></a><span class="p">(</span><span class="n">moving_aligned</span><span class="p">,</span> <span class="n">deformed_bundle</span><span class="p">,</span>
                <span class="n">fname</span><span class="o">=</span><span class="s2">&quot;linearly_and_nonlinearly_moved.png&quot;</span><span class="p">,</span> <span class="n">c1</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>Now, let’s visualize deformation vector field generated by BundleWarp.
This shows us visually where and how much and in what directions deformations
were added by BundleWarp.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">offsets</span><span class="p">,</span> <span class="n">directions</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <a href="../../reference/dipy.align.html#dipy.align.streamwarp.bundlewarp_vector_filed" title="dipy.align.streamwarp.bundlewarp_vector_filed" class="sphx-glr-backref-module-dipy-align-streamwarp sphx-glr-backref-type-py-function"><span class="n">bundlewarp_vector_filed</span></a><span class="p">(</span><span class="n">moving_aligned</span><span class="p">,</span>
                                                      <span class="n">deformed_bundle</span><span class="p">)</span>

<span class="n">points_aligned</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <a href="../../reference/dipy.tracking.html#dipy.tracking.streamline.unlist_streamlines" title="dipy.tracking.streamline.unlist_streamlines" class="sphx-glr-backref-module-dipy-tracking-streamline sphx-glr-backref-type-py-function"><span class="n">unlist_streamlines</span></a><span class="p">(</span><span class="n">moving_aligned</span><span class="p">)</span>
</pre></div>
</div>
<p>Visualizing just the vector field.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;partially_vectorfield.png&quot;</span>
<a href="../../reference/dipy.viz.html#dipy.viz.streamline.viz_vector_field" title="dipy.viz.streamline.viz_vector_field" class="sphx-glr-backref-module-dipy-viz-streamline sphx-glr-backref-type-py-function"><span class="n">viz_vector_field</span></a><span class="p">(</span><span class="n">points_aligned</span><span class="p">,</span> <span class="n">directions</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s visualize vector field over linearly moved bundle. This will show how
much deformations were introduced after linear registration.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;partially_vectorfield_over_linearly_moved.png&quot;</span>
<a href="../../reference/dipy.viz.html#dipy.viz.streamline.viz_vector_field" title="dipy.viz.streamline.viz_vector_field" class="sphx-glr-backref-module-dipy-viz-streamline sphx-glr-backref-type-py-function"><span class="n">viz_vector_field</span></a><span class="p">(</span><span class="n">points_aligned</span><span class="p">,</span> <span class="n">directions</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span>
                 <span class="n">moving_aligned</span><span class="p">)</span>
</pre></div>
</div>
<p>We can also visualize the magnitude of deformations in mm mapped over affinely
moved bundle. It shows which streamlines were deformed the most after affine
registration.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;partially_deformation_magnitude_over_linearly_moved.png&quot;</span>
<a href="../../reference/dipy.viz.html#dipy.viz.streamline.viz_displacement_mag" title="dipy.viz.streamline.viz_displacement_mag" class="sphx-glr-backref-module-dipy-viz-streamline sphx-glr-backref-type-py-function"><span class="n">viz_displacement_mag</span></a><span class="p">(</span><span class="n">moving_aligned</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Saving partially warped bundle.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">new_tractogram</span> <span class="o">=</span> <a href="../../reference/dipy.io.html#dipy.io.stateful_tractogram.StatefulTractogram" title="dipy.io.stateful_tractogram.StatefulTractogram" class="sphx-glr-backref-module-dipy-io-stateful_tractogram sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">StatefulTractogram</span></a><span class="p">(</span><span class="n">deformed_bundle</span><span class="p">,</span> <span class="n">m_UF_L_path</span><span class="p">,</span> <a href="../../reference/dipy.io.html#dipy.io.stateful_tractogram.Space.RASMM" title="dipy.io.stateful_tractogram.Space.RASMM" class="sphx-glr-backref-module-dipy-io-stateful_tractogram-Space sphx-glr-backref-type-py-attribute"><span class="n">Space</span><span class="o">.</span><span class="n">RASMM</span></a><span class="p">)</span>
<a href="../../reference/dipy.io.html#dipy.io.streamline.save_tractogram" title="dipy.io.streamline.save_tractogram" class="sphx-glr-backref-module-dipy-io-streamline sphx-glr-backref-type-py-function"><span class="n">save_tractogram</span></a><span class="p">(</span><span class="n">new_tractogram</span><span class="p">,</span> <span class="s2">&quot;partially_deformed_bundle.trk&quot;</span><span class="p">,</span>
                <span class="n">bbox_valid_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s fully deform the moving bundle by setting alpha &lt;= 0.01</p>
<p>We will use MDF distances computed and returned by previous run of BundleWarp
method. This will save computation time.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">deformed_bundle2</span><span class="p">,</span> <span class="n">moving_aligned</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">match_pairs</span><span class="p">,</span> <span class="n">warp_map</span> <span class="o">=</span> <a href="../../reference/dipy.align.html#dipy.align.streamwarp.bundlewarp" title="dipy.align.streamwarp.bundlewarp" class="sphx-glr-backref-module-dipy-align-streamwarp sphx-glr-backref-type-py-function"><span class="n">bundlewarp</span></a><span class="p">(</span>
        <span class="n">static</span><span class="p">,</span> <span class="n">moving</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">distances</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time taken by BundleWarp registration in seconds = &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s visualize static bundle in red and moved (completely warped) in green.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><a href="../../reference/dipy.viz.html#dipy.viz.streamline.viz_two_bundles" title="dipy.viz.streamline.viz_two_bundles" class="sphx-glr-backref-module-dipy-viz-streamline sphx-glr-backref-type-py-function"><span class="n">viz_two_bundles</span></a><span class="p">(</span><span class="n">static</span><span class="p">,</span> <span class="n">deformed_bundle2</span><span class="p">,</span>
                <span class="n">fname</span><span class="o">=</span><span class="s2">&quot;static_and_fully_deformed.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, let’s visualize the deformation vector field generated by BundleWarp.
This shows us visually where and how much and in what directions deformations
were added by BundleWarp to perfectly warp moving bundle to look like static.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">offsets</span><span class="p">,</span> <span class="n">directions</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <a href="../../reference/dipy.align.html#dipy.align.streamwarp.bundlewarp_vector_filed" title="dipy.align.streamwarp.bundlewarp_vector_filed" class="sphx-glr-backref-module-dipy-align-streamwarp sphx-glr-backref-type-py-function"><span class="n">bundlewarp_vector_filed</span></a><span class="p">(</span><span class="n">moving_aligned</span><span class="p">,</span>
                                                      <span class="n">deformed_bundle2</span><span class="p">)</span>

<span class="n">points_aligned</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <a href="../../reference/dipy.tracking.html#dipy.tracking.streamline.unlist_streamlines" title="dipy.tracking.streamline.unlist_streamlines" class="sphx-glr-backref-module-dipy-tracking-streamline sphx-glr-backref-type-py-function"><span class="n">unlist_streamlines</span></a><span class="p">(</span><span class="n">moving_aligned</span><span class="p">)</span>
</pre></div>
</div>
<p>Visualizing just the vector field.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;fully_vectorfield.png&quot;</span>
<a href="../../reference/dipy.viz.html#dipy.viz.streamline.viz_vector_field" title="dipy.viz.streamline.viz_vector_field" class="sphx-glr-backref-module-dipy-viz-streamline sphx-glr-backref-type-py-function"><span class="n">viz_vector_field</span></a><span class="p">(</span><span class="n">points_aligned</span><span class="p">,</span> <span class="n">directions</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s visualize vector field over linearly moved bundle. This will show how
much deformations were introduced after linear registration by fully deforming
the moving bundle.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;fully_vectorfield_over_linearly_moved.png&quot;</span>
<a href="../../reference/dipy.viz.html#dipy.viz.streamline.viz_vector_field" title="dipy.viz.streamline.viz_vector_field" class="sphx-glr-backref-module-dipy-viz-streamline sphx-glr-backref-type-py-function"><span class="n">viz_vector_field</span></a><span class="p">(</span><span class="n">points_aligned</span><span class="p">,</span> <span class="n">directions</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span>
                 <span class="n">moving_aligned</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s visualize the magnitude of deformations in mm mapped over affinely moved
bundle. It shows which streamlines were deformed the most after affine
registration.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;fully_deformation_magnitude_over_linearly_moved.png&quot;</span>
<a href="../../reference/dipy.viz.html#dipy.viz.streamline.viz_displacement_mag" title="dipy.viz.streamline.viz_displacement_mag" class="sphx-glr-backref-module-dipy-viz-streamline sphx-glr-backref-type-py-function"><span class="n">viz_displacement_mag</span></a><span class="p">(</span><span class="n">moving_aligned</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>We can also perform bundle shape difference analysis using the displacement
field generated by fully warping the moving bundle to look exactly like static
bundle. Here, we plot bundle shape profile using BUAN. Bundle shape profile
shows the average magnitude of deformations along the length of the bundle.
Segments where we observe higher deformations are the areas where two bundles
differ the most in shape.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <a href="../../reference/dipy.align.html#dipy.align.streamwarp.bundlewarp_shape_analysis" title="dipy.align.streamwarp.bundlewarp_shape_analysis" class="sphx-glr-backref-module-dipy-align-streamwarp sphx-glr-backref-type-py-function"><span class="n">bundlewarp_shape_analysis</span></a><span class="p">(</span><span class="n">moving_aligned</span><span class="p">,</span> <span class="n">deformed_bundle</span><span class="p">,</span> <span class="n">no_disks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                 <span class="n">plotting</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Saving fully warped bundle.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">new_tractogram</span> <span class="o">=</span> <a href="../../reference/dipy.io.html#dipy.io.stateful_tractogram.StatefulTractogram" title="dipy.io.stateful_tractogram.StatefulTractogram" class="sphx-glr-backref-module-dipy-io-stateful_tractogram sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">StatefulTractogram</span></a><span class="p">(</span><span class="n">deformed_bundle2</span><span class="p">,</span> <span class="n">m_UF_L_path</span><span class="p">,</span>
                                    <a href="../../reference/dipy.io.html#dipy.io.stateful_tractogram.Space.RASMM" title="dipy.io.stateful_tractogram.Space.RASMM" class="sphx-glr-backref-module-dipy-io-stateful_tractogram-Space sphx-glr-backref-type-py-attribute"><span class="n">Space</span><span class="o">.</span><span class="n">RASMM</span></a><span class="p">)</span>
<a href="../../reference/dipy.io.html#dipy.io.streamline.save_tractogram" title="dipy.io.streamline.save_tractogram" class="sphx-glr-backref-module-dipy-io-streamline sphx-glr-backref-type-py-function"><span class="n">save_tractogram</span></a><span class="p">(</span><span class="n">new_tractogram</span><span class="p">,</span> <span class="s2">&quot;fully_deformed_bundle.trk&quot;</span><span class="p">,</span>
                <span class="n">bbox_valid_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this heading">#</a></h2>
<div role="list" class="citation-list">
<div class="citation" id="chandio23" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>Chandio23<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id1">1</a>,<a role="doc-backlink" href="#id3">2</a>)</span>
<p>Chandio et al., “BundleWarp, streamline-based nonlinear
registration of white matter tracts.”
bioRxiv (2023): 2023-01.</p>
</div>
<div class="citation" id="chandio20" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">Chandio20</a><span class="fn-bracket">]</span></span>
<p>Chandio and Garyfallidis., “StND: Streamline-based non-rigid
partial-deformation tractography registration.” Medical
Imaging Meets NeurIPS (2020).</p>
</div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  0.000 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-registration-bundlewarp-registration-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/c09e6612eaebbaff3989527671f8d5a7/bundlewarp_registration.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">bundlewarp_registration.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/7b954642673068db4886db69485edb64/bundlewarp_registration.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">bundlewarp_registration.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>

<div class="section ablog__blog_comments">
  
  
</div>

                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  
<script type="module" src="../../_static/scripts/grg-sphinx-theme.js"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2008-2023, dipy developers &lt;neuroimaging@python.org&gt;.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.0.0.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

    <div class="copyright-text">
      <i class="fa-regular fa-copyright"></i> 
    </div>
  </footer>
  </body>
</html>